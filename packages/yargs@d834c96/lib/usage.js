var cliui=require("cliui"),decamelize=require("decamelize"),wsize=require("window-size");module.exports=function(n){function e(n){var e=0;return Array.isArray(n)||(n=Object.keys(n).map(function(e){return[n[e]]})),n.forEach(function(n){e=Math.max(n[0].length,e)}),g&&(e=Math.min(e,parseInt(.5*g,10))),e}function i(){var e=n.getOptions(),i=n.getDemanded();(Object.keys(e.alias)||[]).forEach(function(r){e.alias[r].forEach(function(t){d[t]&&o.describe(r,d[t]),i[t]&&n.demand(r,i[t].msg),~e["boolean"].indexOf(t)&&n["boolean"](r),~e.count.indexOf(t)&&n.count(r),~e.string.indexOf(t)&&n.string(r),~e.normalize.indexOf(t)&&n.normalize(r),~e.array.indexOf(t)&&n.array(r)})})}function r(n,e){var i="[default: ";if(void 0===n)return null;if(e)i+=e;else switch(typeof n){case"string":i+=JSON.stringify(n);break;case"object":i+=JSON.stringify(n);break;default:i+=n}return i+"]"}function t(){return wsize.width?Math.min(80,wsize.width):null}var o={},a=[];o.failFn=function(n){a.push(n)};var c=null,u=!0;o.showHelpOnFail=function(n,e){return"string"==typeof n?(e=n,n=!0):"undefined"==typeof n&&(n=!0),c=e,u=n,o},o.fail=function(e){if(a.length)a.forEach(function(n){n(e)});else{if(u&&n.showHelp("error"),e&&console.error(e),c&&(e&&console.error(""),console.error(c)),!n.getExitProcess())throw new Error(e);process.exit(1)}};var f;o.usage=function(n){f=n};var s=[];o.example=function(n,e){s.push([n,e||""])};var l=[];o.command=function(n,e){l.push([n,e||""])},o.getCommands=function(){return l};var d={};o.describe=function(n,e){"object"==typeof n?Object.keys(n).forEach(function(e){o.describe(e,n[e])}):d[n]=e},o.getDescriptions=function(){return d};var p;o.epilog=function(n){p=n};var g=t();o.wrap=function(n){g=n},o.help=function(){i();var t=n.getDemanded(),o=n.getOptions(),a=Object.keys(Object.keys(d).concat(Object.keys(t)).concat(Object.keys(o["default"])).reduce(function(n,e){return"_"!==e&&(n[e]=!0),n},{})),c=cliui({width:g,wrap:!!g});if(f){var u=f.replace(/\$0/g,n.$0);c.div(u+"\n")}l.length&&(c.div("Commands:"),l.forEach(function(n){c.div({text:n[0],padding:[0,2,0,2],width:e(l)+4},{text:n[1]})}),c.div());var v=(Object.keys(o.alias)||[]).concat(Object.keys(n.parsed.newAliases)||[]);a=a.filter(function(e){return!n.parsed.newAliases[e]&&v.every(function(n){return(o.alias[n]||[]).indexOf(e)===-1})});var h=a.reduce(function(n,e){return n[e]=[e].concat(o.alias[e]||[]).map(function(n){return(n.length>1?"--":"-")+n}).join(", "),n},{});if(a.length&&(c.div("Options:"),a.forEach(function(n){var i=h[n],a=d[n]||"",u=null;~o["boolean"].indexOf(n)&&(u="[boolean]"),~o.count.indexOf(n)&&(u="[count]"),~o.string.indexOf(n)&&(u="[string]"),~o.normalize.indexOf(n)&&(u="[string]"),~o.array.indexOf(n)&&(u="[array]");var f=[u,t[n]?"[required]":null,r(o["default"][n],o.defaultDescription[n])].filter(Boolean).join(" ");c.span({text:i,padding:[0,2,0,2],width:e(h)+4},a),f?c.div({text:f,padding:[0,0,0,2],align:"right"}):c.div()}),c.div()),s.length&&(c.div("Examples:"),s.forEach(function(e){e[0]=e[0].replace(/\$0/g,n.$0)}),s.forEach(function(n){c.div({text:n[0],padding:[0,2,0,2],width:e(s)+4},n[1])}),c.div()),p){var m=p.replace(/\$0/g,n.$0);c.div(m+"\n")}return c.toString()},o.showHelp=function(n){n=n||"error",console[n](o.help())},o.functionDescription=function(n,e){if(e)return e;var i=n.name?decamelize(n.name,"-"):"generated-value";return["(",i,")"].join("")};var v=null;return o.version=function(n,e,i){v=n},o.showVersion=function(){"function"==typeof v?console.log(v()):console.log(v)},o};