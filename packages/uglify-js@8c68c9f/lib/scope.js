"use strict";function SymbolDef(e,n,a){this.name=a.name,this.orig=[a],this.scope=e,this.references=[],this.global=!1,this.mangled_name=null,this.undeclared=!1,this.constant=!1,this.index=n,this.id=SymbolDef.next_id++}SymbolDef.next_id=1,SymbolDef.prototype={unmangleable:function(e){return e||(e={}),this.global&&!e.toplevel||this.undeclared||!e.eval&&(this.scope.uses_eval||this.scope.uses_with)||e.keep_fnames&&(this.orig[0]instanceof AST_SymbolLambda||this.orig[0]instanceof AST_SymbolDefun)},mangle:function(e){var n=e.cache&&e.cache.props;if(this.global&&n&&n.has(this.name))this.mangled_name=n.get(this.name);else if(!this.mangled_name&&!this.unmangleable(e)){var a=this.scope;!e.screw_ie8&&this.orig[0]instanceof AST_SymbolLambda&&(a=a.parent_scope),this.mangled_name=a.next_mangled(e,this),this.global&&n&&n.set(this.name,this.mangled_name)}}},AST_Toplevel.DEFMETHOD("figure_out_scope",function(e){e=defaults(e,{screw_ie8:!1,cache:null});var n=this,a=n.parent_scope=null,t=new Dictionary,i=null,s=!1,o=0,r=new TreeWalker(function(n,c){if(e.screw_ie8&&n instanceof AST_Catch){var l=a;return a=new AST_Scope(n),a.init_scope_vars(o),a.parent_scope=l,c(),a=l,!0}if(n instanceof AST_Scope){n.init_scope_vars(o);var l=n.parent_scope=a,f=i,_=t;return i=a=n,t=new Dictionary,++o,c(),--o,a=l,i=f,t=_,!0}if(n instanceof AST_LabeledStatement){var u=n.label;if(t.has(u.name))throw new Error(string_template("Label {name} defined twice",u));return t.set(u.name,u),c(),t.del(u.name),!0}if(n instanceof AST_With)for(var d=a;d;d=d.parent_scope)d.uses_with=!0;else if(n instanceof AST_Symbol&&(n.scope=a),n instanceof AST_Label&&(n.thedef=n,n.references=[]),n instanceof AST_SymbolLambda)i.def_function(n);else if(n instanceof AST_SymbolDefun)(n.scope=i.parent_scope).def_function(n);else if(n instanceof AST_Var)s=n.has_const_pragma();else if(n instanceof AST_SymbolVar||n instanceof AST_SymbolConst){var m=i.def_variable(n);m.constant=n instanceof AST_SymbolConst||s,m.init=r.parent().value}else if(n instanceof AST_SymbolCatch)(e.screw_ie8?a:i).def_variable(n);else if(n instanceof AST_LabelRef){var S=t.get(n.name);if(!S)throw new Error(string_template("Undefined label {name} [{line},{col}]",{name:n.name,line:n.start.line,col:n.start.col}));n.thedef=S}});n.walk(r);var c=null,l=n.globals=new Dictionary,r=new TreeWalker(function(e,a){if(e instanceof AST_Lambda){var t=c;return c=e,a(),c=t,!0}if(e instanceof AST_LoopControl&&e.label)return e.label.thedef.references.push(e),!0;if(e instanceof AST_SymbolRef){var i=e.name;if("eval"==i&&r.parent()instanceof AST_Call)for(var s=e.scope;s&&!s.uses_eval;s=s.parent_scope)s.uses_eval=!0;var o=e.scope.find_variable(i);if(o)e.thedef=o;else{var f;l.has(i)?f=l.get(i):(f=new SymbolDef(n,l.size(),e),f.undeclared=!0,f.global=!0,l.set(i,f)),e.thedef=f,c&&"arguments"==i&&(c.uses_arguments=!0)}return e.reference(),!0}});n.walk(r),e.cache&&(this.cname=e.cache.cname)}),AST_Scope.DEFMETHOD("init_scope_vars",function(e){this.variables=new Dictionary,this.functions=new Dictionary,this.uses_with=!1,this.uses_eval=!1,this.parent_scope=null,this.enclosed=[],this.cname=-1,this.nesting=e}),AST_Lambda.DEFMETHOD("init_scope_vars",function(){AST_Scope.prototype.init_scope_vars.apply(this,arguments),this.uses_arguments=!1;var e=new AST_VarDef({name:"arguments",start:this.start,end:this.end}),n=new SymbolDef(this,this.variables.size(),e);this.variables.set(e.name,n)}),AST_SymbolRef.DEFMETHOD("reference",function(){var e=this.definition();e.references.push(this);for(var n=this.scope;n&&(push_uniq(n.enclosed,e),n!==e.scope);)n=n.parent_scope;this.frame=this.scope.nesting-e.scope.nesting}),AST_Scope.DEFMETHOD("find_variable",function(e){return e instanceof AST_Symbol&&(e=e.name),this.variables.get(e)||this.parent_scope&&this.parent_scope.find_variable(e)}),AST_Scope.DEFMETHOD("def_function",function(e){this.functions.set(e.name,this.def_variable(e))}),AST_Scope.DEFMETHOD("def_variable",function(e){var n;return this.variables.has(e.name)?(n=this.variables.get(e.name),n.orig.push(e)):(n=new SymbolDef(this,this.variables.size(),e),this.variables.set(e.name,n),n.global=!this.parent_scope),e.thedef=n}),AST_Scope.DEFMETHOD("next_mangled",function(e){var n=this.enclosed;e:for(;;){var a=base54(++this.cname);if(is_identifier(a)&&!(e.except.indexOf(a)>=0)){for(var t=n.length;--t>=0;){var i=n[t],s=i.mangled_name||i.unmangleable(e)&&i.name;if(a==s)continue e}return a}}}),AST_Function.DEFMETHOD("next_mangled",function(e,n){for(var a=n.orig[0]instanceof AST_SymbolFunarg&&this.name&&this.name.definition();;){var t=AST_Lambda.prototype.next_mangled.call(this,e,n);if(!a||a.mangled_name!=t)return t}}),AST_Scope.DEFMETHOD("references",function(e){return e instanceof AST_Symbol&&(e=e.definition()),this.enclosed.indexOf(e)<0?null:e}),AST_Symbol.DEFMETHOD("unmangleable",function(e){return this.definition().unmangleable(e)}),AST_SymbolAccessor.DEFMETHOD("unmangleable",function(){return!0}),AST_Label.DEFMETHOD("unmangleable",function(){return!1}),AST_Symbol.DEFMETHOD("unreferenced",function(){return 0==this.definition().references.length&&!(this.scope.uses_eval||this.scope.uses_with)}),AST_Symbol.DEFMETHOD("undeclared",function(){return this.definition().undeclared}),AST_LabelRef.DEFMETHOD("undeclared",function(){return!1}),AST_Label.DEFMETHOD("undeclared",function(){return!1}),AST_Symbol.DEFMETHOD("definition",function(){return this.thedef}),AST_Symbol.DEFMETHOD("global",function(){return this.definition().global}),AST_Var.DEFMETHOD("has_const_pragma",function(){var e=this.start&&this.start.comments_before,n=e&&e[e.length-1];return n&&/@const\b/.test(n.value)}),AST_Toplevel.DEFMETHOD("_default_mangler_options",function(e){return defaults(e,{except:[],eval:!1,sort:!1,toplevel:!1,screw_ie8:!1,keep_fnames:!1})}),AST_Toplevel.DEFMETHOD("mangle_names",function(e){e=this._default_mangler_options(e),e.except.push("arguments");var n=-1,a=[];e.cache&&this.globals.each(function(n){e.except.indexOf(n.name)<0&&a.push(n)});var t=new TreeWalker(function(i,s){if(i instanceof AST_LabeledStatement){var o=n;return s(),n=o,!0}if(i instanceof AST_Scope){var r=(t.parent(),[]);return i.variables.each(function(n){e.except.indexOf(n.name)<0&&r.push(n)}),void a.push.apply(a,r)}if(i instanceof AST_Label){var c;do c=base54(++n);while(!is_identifier(c));return i.mangled_name=c,!0}if(e.screw_ie8&&i instanceof AST_SymbolCatch)return void a.push(i.definition())});this.walk(t),a.forEach(function(n){n.mangle(e)}),e.cache&&(e.cache.cname=this.cname)}),AST_Toplevel.DEFMETHOD("compute_char_frequency",function(e){e=this._default_mangler_options(e);var n=new TreeWalker(function(n){n instanceof AST_Constant?base54.consider(n.print_to_string()):n instanceof AST_Return?base54.consider("return"):n instanceof AST_Throw?base54.consider("throw"):n instanceof AST_Continue?base54.consider("continue"):n instanceof AST_Break?base54.consider("break"):n instanceof AST_Debugger?base54.consider("debugger"):n instanceof AST_Directive?base54.consider(n.value):n instanceof AST_While?base54.consider("while"):n instanceof AST_Do?base54.consider("do while"):n instanceof AST_If?(base54.consider("if"),n.alternative&&base54.consider("else")):n instanceof AST_Var?base54.consider("var"):n instanceof AST_Const?base54.consider("const"):n instanceof AST_Lambda?base54.consider("function"):n instanceof AST_For?base54.consider("for"):n instanceof AST_ForIn?base54.consider("for in"):n instanceof AST_Switch?base54.consider("switch"):n instanceof AST_Case?base54.consider("case"):n instanceof AST_Default?base54.consider("default"):n instanceof AST_With?base54.consider("with"):n instanceof AST_ObjectSetter?base54.consider("set"+n.key):n instanceof AST_ObjectGetter?base54.consider("get"+n.key):n instanceof AST_ObjectKeyVal?base54.consider(n.key):n instanceof AST_New?base54.consider("new"):n instanceof AST_This?base54.consider("this"):n instanceof AST_Try?base54.consider("try"):n instanceof AST_Catch?base54.consider("catch"):n instanceof AST_Finally?base54.consider("finally"):n instanceof AST_Symbol&&n.unmangleable(e)?base54.consider(n.name):n instanceof AST_Unary||n instanceof AST_Binary?base54.consider(n.operator):n instanceof AST_Dot&&base54.consider(n.property)});this.walk(n),base54.sort()});var base54=function(){function e(){t=Object.create(null),a=i.split("").map(function(e){return e.charCodeAt(0)}),a.forEach(function(e){t[e]=0})}function n(e){var n="",t=54;e++;do e--,n+=String.fromCharCode(a[e%t]),e=Math.floor(e/t),t=64;while(e>0);return n}var a,t,i="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_0123456789";return n.consider=function(e){for(var n=e.length;--n>=0;){var a=e.charCodeAt(n);a in t&&++t[a]}},n.sort=function(){a=mergeSort(a,function(e,n){return is_digit(e)&&!is_digit(n)?1:is_digit(n)&&!is_digit(e)?-1:t[n]-t[e]})},n.reset=e,e(),n.get=function(){return a},n.freq=function(){return t},n}();AST_Toplevel.DEFMETHOD("scope_warnings",function(e){e=defaults(e,{undeclared:!1,unreferenced:!0,assign_to_global:!0,func_arguments:!0,nested_defuns:!0,eval:!0});var n=new TreeWalker(function(a){if(e.undeclared&&a instanceof AST_SymbolRef&&a.undeclared()&&AST_Node.warn("Undeclared symbol: {name} [{file}:{line},{col}]",{name:a.name,file:a.start.file,line:a.start.line,col:a.start.col}),e.assign_to_global){var t=null;a instanceof AST_Assign&&a.left instanceof AST_SymbolRef?t=a.left:a instanceof AST_ForIn&&a.init instanceof AST_SymbolRef&&(t=a.init),t&&(t.undeclared()||t.global()&&t.scope!==t.definition().scope)&&AST_Node.warn("{msg}: {name} [{file}:{line},{col}]",{msg:t.undeclared()?"Accidental global?":"Assignment to global",name:t.name,file:t.start.file,line:t.start.line,col:t.start.col})}e.eval&&a instanceof AST_SymbolRef&&a.undeclared()&&"eval"==a.name&&AST_Node.warn("Eval is used [{file}:{line},{col}]",a.start),e.unreferenced&&(a instanceof AST_SymbolDeclaration||a instanceof AST_Label)&&!(a instanceof AST_SymbolCatch)&&a.unreferenced()&&AST_Node.warn("{type} {name} is declared but not referenced [{file}:{line},{col}]",{type:a instanceof AST_Label?"Label":"Symbol",name:a.name,file:a.start.file,line:a.start.line,col:a.start.col}),e.func_arguments&&a instanceof AST_Lambda&&a.uses_arguments&&AST_Node.warn("arguments used in function {name} [{file}:{line},{col}]",{name:a.name?a.name.name:"anonymous",file:a.start.file,line:a.start.line,col:a.start.col}),e.nested_defuns&&a instanceof AST_Defun&&!(n.parent()instanceof AST_Scope)&&AST_Node.warn('Function {name} declared in nested statement "{type}" [{file}:{line},{col}]',{name:a.name.name,type:n.parent().TYPE,file:a.start.file,line:a.start.line,col:a.start.col})});this.walk(n)});