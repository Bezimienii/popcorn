"use strict";var _=require("lodash"),events=require("events"),marker={},scopeManager=function(e,n,a,t){function o(e){b={"(labels)":Object.create(null),"(usages)":Object.create(null),"(breakLabels)":Object.create(null),"(parent)":b,"(type)":e,"(params)":"functionparams"===e||"catchparams"===e?[]:null},g.push(b)}function s(e,n){y.emit("warning",{code:e,token:n,data:_.slice(arguments,2)})}function r(e,n){y.emit("warning",{code:e,token:n,data:_.slice(arguments,2)})}function i(e){b["(usages)"][e]||(b["(usages)"][e]={"(modified)":[],"(reassigned)":[],"(tokens)":[]})}function l(){if("functionparams"===b["(type)"])return void u();var e=b["(labels)"];for(var n in e)e[n]&&"exception"!==e[n]["(type)"]&&e[n]["(unused)"]&&O(n,e[n]["(token)"],"var")}function u(){var n=b["(params)"];if(n)for(var a,t=n.pop();t;){var o=b["(labels)"][t];if(a=W(e.funct["(unusedOption)"]),"undefined"===t)return;if(o["(unused)"])O(t,o["(token)"],"param",e.funct["(unusedOption)"]);else if("last-param"===a)return;t=n.pop()}}function f(e){for(var n=g.length-1;n>=0;--n){var a=g[n]["(labels)"];if(a[e])return a}}function c(e){for(var n=g.length-1;n>=0;n--){var a=g[n];if(a["(usages)"][e])return a["(usages)"][e];if(a===v)break}return!1}function d(n,a){if("outer"===e.option.shadow)for(var t="global"===v["(type)"],o="functionparams"===b["(type)"],r=!t,i=0;i<g.length;i++){var l=g[i];o||g[i+1]!==v||(r=!1),r&&l["(labels)"][n]&&s("W123",a,n),l["(breakLabels)"][n]&&s("W123",a,n)}}function p(n,a,t){e.option.latedef&&(e.option.latedef===!0&&"function"===n||"function"!==n)&&s("W003",t,a)}var b,g=[];o("global"),b["(predefined)"]=n;var v=b,h=Object.create(null),m=Object.create(null),k=[],y=new events.EventEmitter,W=function(n){return void 0===n&&(n=e.option.unused),n===!0&&(n="last-param"),n},O=function(e,n,a,t){var o=n.line,r=n.from,i=n.raw_text||e;t=W(t);var l={vars:["var"],"last-param":["var","param"],strict:["var","param","last-param"]};t&&l[t]&&l[t].indexOf(a)!==-1&&s("W098",{line:o,from:r},i),(t||"var"===a)&&k.push({name:e,line:o,character:r})},x={on:function(e,n){e.split(" ").forEach(function(e){y.on(e,n)})},isPredefined:function(e){return!this.has(e)&&_.has(g[0]["(predefined)"],e)},stack:function(e){var n=b;o(e),e||"functionparams"!==n["(type)"]||(b["(isFuncBody)"]=!0,b["(context)"]=v,v=b)},unstack:function(){var n,a,o=g.length>1?g[g.length-2]:null,i=b===v,u="functionparams"===b["(type)"],f="functionouter"===b["(type)"],c=b["(usages)"],d=b["(labels)"],p=Object.keys(c);for(c.__proto__&&p.indexOf("__proto__")===-1&&p.push("__proto__"),n=0;n<p.length;n++){var k=p[n],y=c[k],W=d[k];if(W){var x=W["(type)"],E="const"===x||"import"===x;if(W["(useOutsideOfScope)"]&&!e.option.funcscope){var B=y["(tokens)"];if(B)for(a=0;a<B.length;a++)W["(function)"]===B[a]["(function)"]&&r("W038",B[a],k)}if(b["(labels)"][k]["(unused)"]=!1,E&&y["(modified)"])for(a=0;a<y["(modified)"].length;a++)r("E013",y["(modified)"][a],k);if(("function"===x||"class"===x)&&y["(reassigned)"])for(a=0;a<y["(reassigned)"].length;a++)y["(reassigned)"][a].ignoreW021||s("W021",y["(reassigned)"][a],k,x)}else if(f&&(e.funct["(isCapturing)"]=!0),o)if(o["(usages)"][k]){var U=o["(usages)"][k];U["(modified)"]=U["(modified)"].concat(y["(modified)"]),U["(tokens)"]=U["(tokens)"].concat(y["(tokens)"]),U["(reassigned)"]=U["(reassigned)"].concat(y["(reassigned)"])}else o["(usages)"][k]=y,i&&(o["(usages)"][k]["(onlyUsedSubFunction)"]=!0);else if("boolean"==typeof b["(predefined)"][k]){if(delete t[k],h[k]=marker,b["(predefined)"][k]===!1&&y["(reassigned)"])for(a=0;a<y["(reassigned)"].length;a++)y["(reassigned)"][a].ignoreW020||s("W020",y["(reassigned)"][a])}else if(y["(tokens)"])for(a=0;a<y["(tokens)"].length;a++){var j=y["(tokens)"][a];j.forgiveUndef||(e.option.undef&&!j.ignoreUndef&&s("W117",j,k),m[k]?m[k].line.push(j.line):m[k]={name:k,line:[j.line]})}}if(o||Object.keys(t).forEach(function(e){O(e,t[e],"var")}),o&&!i&&!u&&!f){var w=Object.keys(d);for(n=0;n<w.length;n++){var L=w[n],S=d[L];if(!S["(blockscoped)"]&&"exception"!==S["(type)"]){var F=o["(labels)"][L];F?F["(unused)"]&=S["(unused)"]:(S["(useOutsideOfScope)"]="global"!==v["(type)"]&&!this.funct.has(L,{excludeCurrent:!0}),o["(labels)"][L]=S),delete d[L]}}}l(),g.pop(),i&&(v=g[_.findLastIndex(g,function(e){return e["(isFuncBody)"]||"global"===e["(type)"]})]),b=o},addParam:function(n,a,t){if(t=t||"param","exception"===t){var o=this.funct.labeltype(n);o&&"exception"!==o&&(e.option.node||s("W002",e.tokens.next,n))}if(_.has(b["(labels)"],n)?b["(labels)"][n].duplicated=!0:(d(n,a,t),b["(labels)"][n]={"(type)":t,"(token)":a,"(unused)":!0},b["(params)"].push(n)),_.has(b["(usages)"],n)){var r=b["(usages)"][n];r["(onlyUsedSubFunction)"]?p(t,n,a):s("E056",a,n,t)}},validateParams:function(){if("global"!==v["(type)"]){var n=e.isStrict(),a=v["(parent)"];a["(params)"]&&a["(params)"].forEach(function(t){var o=a["(labels)"][t];o&&o.duplicated&&(n?s("E011",o["(token)"],t):e.option.shadow!==!0&&s("W004",o["(token)"],t))})}},getUsedOrDefinedGlobals:function(){var e=Object.keys(h);return h.__proto__===marker&&e.indexOf("__proto__")===-1&&e.push("__proto__"),e},getImpliedGlobals:function(){var e=_.values(m),n=!1;return m.__proto__&&(n=e.some(function(e){return"__proto__"===e.name}),n||e.push(m.__proto__)),e},getUnuseds:function(){return k},has:function(e){return Boolean(f(e))},labeltype:function(e){var n=f(e);return n?n[e]["(type)"]:null},addExported:function(e){var n=g[0]["(labels)"];if(_.has(t,e))delete t[e];else if(_.has(n,e))n[e]["(unused)"]=!1;else{for(var o=1;o<g.length;o++){var s=g[o];if(s["(type)"])break;if(_.has(s["(labels)"],e)&&!s["(labels)"][e]["(blockscoped)"])return void(s["(labels)"][e]["(unused)"]=!1)}a[e]=!0}},setExported:function(e,n){this.block.use(e,n)},initialize:function(e){b["(labels)"][e]&&(b["(labels)"][e]["(initialized)"]=!0)},addlabel:function(n,t){var o=t.type,r=t.token,i="let"===o||"const"===o||"class"===o||"import"===o,l="function"===o||"import"===o,u="global"===(i?b:v)["(type)"]&&_.has(a,n);if(d(n,r,o),i){var f=b["(labels)"][n];if(f||b!==v||"global"===b["(type)"]||(f=!!v["(parent)"]["(labels)"][n]),!f&&b["(usages)"][n]){var g=b["(usages)"][n];g["(onlyUsedSubFunction)"]||l?p(o,n,r):l||s("E056",r,n,o)}f?s("E011",r,n):"outer"===e.option.shadow&&x.funct.has(n)&&s("W004",r,n),x.block.add(n,o,r,!u,t.initialized)}else{var m=x.funct.has(n);!m&&c(n)&&p(o,n,r),x.funct.has(n,{onlyBlockscoped:!0})?s("E011",r,n):e.option.shadow!==!0&&m&&"__proto__"!==n&&"global"!==v["(type)"]&&s("W004",r,n),x.funct.add(n,o,r,!u),"global"!==v["(type)"]||e.impliedClosure()||(h[n]=marker)}},funct:{labeltype:function(e,n){for(var a=n&&n.onlyBlockscoped,t=n&&n.excludeParams,o=g.length-(n&&n.excludeCurrent?2:1),s=o;s>=0;s--){var r=g[s];if(r["(labels)"][e]&&(!a||r["(labels)"][e]["(blockscoped)"]))return r["(labels)"][e]["(type)"];var i=t?g[s-1]:r;if(i&&"functionparams"===i["(type)"])return null}return null},hasBreakLabel:function(e){for(var n=g.length-1;n>=0;n--){var a=g[n];if(a["(breakLabels)"][e])return!0;if("functionparams"===a["(type)"])return!1}return!1},has:function(e,n){return Boolean(this.labeltype(e,n))},add:function(e,n,a,t){b["(labels)"][e]={"(type)":n,"(token)":a,"(blockscoped)":!1,"(function)":v,"(unused)":t}}},block:{isGlobal:function(){return"global"===b["(type)"]},use:function(n,a){var t=v["(parent)"];t&&t["(labels)"][n]&&"param"===t["(labels)"][n]["(type)"]&&(x.funct.has(n,{excludeParams:!0,onlyBlockscoped:!0})||(t["(labels)"][n]["(unused)"]=!1)),a&&(e.ignored.W117||e.option.undef===!1)&&(a.ignoreUndef=!0),i(n),b["(usages)"][n]["(onlyUsedSubFunction)"]=!1,a&&(a["(function)"]=v,b["(usages)"][n]["(tokens)"].push(a));var o=b["(labels)"][n];o&&o["(blockscoped)"]&&!o["(initialized)"]&&r("E056",a,n,o["(type)"])},reassign:function(n,a){a.ignoreW020=e.ignored.W020,a.ignoreW021=e.ignored.W021,this.modify(n,a),b["(usages)"][n]["(reassigned)"].push(a)},modify:function(e,n){i(e),b["(usages)"][e]["(onlyUsedSubFunction)"]=!1,b["(usages)"][e]["(modified)"].push(n)},add:function(e,n,a,t,o){b["(labels)"][e]={"(type)":n,"(token)":a,"(initialized)":!!o,"(blockscoped)":!0,"(unused)":t}},addBreakLabel:function(n,a){var t=a.token;x.funct.hasBreakLabel(n)?s("E011",t,n):"outer"===e.option.shadow&&(x.funct.has(n)?s("W004",t,n):d(n,t)),b["(breakLabels)"][n]=t}}};return x};module.exports=scopeManager;