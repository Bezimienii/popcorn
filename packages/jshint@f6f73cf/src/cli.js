"use strict";function deprecated(e,r){return r?e+" (DEPRECATED, use "+r+" instead)":e+" (DEPRECATED)"}function findConfig(e){var r,t=path.dirname(path.resolve(e)),n=getHomeDir(),i=findFile(".jshintrc",t);return i?i:n&&(r=path.normalize(path.join(n,".jshintrc")),shjs.test("-e",r))?r:null}function getHomeDir(){for(var e="",r=global.process.env,t=[r.USERPROFILE,r.HOME,r.HOMEPATH,r.HOMEDRIVE+r.HOMEPATH];t.length;)if(e=t.shift(),fs.existsSync(e))return e}function loadNpmConfig(e){var r=path.dirname(path.resolve(e)),t=findFile("package.json",r);if(!t)return null;try{return require(t).jshintConfig}catch(n){return null}}function loadReporter(e){try{return require(e).reporter}catch(r){return null}}function findFile(e,r){r=r||process.cwd();var t=path.normalize(path.join(r,e));if(void 0!==findFileResults[t])return findFileResults[t];var n=path.resolve(r,"../");return shjs.test("-e",t)?(findFileResults[t]=t,t):r===n?(findFileResults[t]=null,null):findFile(e,n)}function loadIgnores(e){var r=findFile(e.excludePath||".jshintignore",e.cwd)||"";if(!r&&!e.exclude)return[];var t=(r?shjs.cat(r):"").split("\n"),n=e.exclude||"";return t.unshift.apply(t,n.split(",")),t.filter(function(e){return!!e.trim()}).map(function(e){return"!"===e[0]?"!"+path.resolve(path.dirname(r),e.substr(1).trim()):path.join(path.dirname(r),e.trim())})}function isIgnored(e,r){return r.some(function(r){return!!minimatch(path.resolve(e),r,{nocase:!0})||(path.resolve(e)===r||(!!(shjs.test("-d",e)&&r.match(/^[^\/\\]*[\/\\]?$/)&&e.match(new RegExp("^"+r+".*")))||void 0))})}function extract(e,r){function t(r,t){"script"===r&&(t.type&&!/text\/javascript/.test(t.type.toLowerCase())||(o=!0,l.push.apply(l,e.slice(a,c.endIndex).match(/\r\n|\n|\r/g)),s=null))}function n(e){"script"===e&&o&&(o=!1,a=c.startIndex,s=null)}function i(e){if(o){var r=e.split(/\r\n|\n|\r/);s||r.some(function(e){if(e)return s=/^(\s*)/.exec(e)[1],!0}),s&&(r=r.map(function(e){return e.replace(s,"")}),e=r.join("\n")),l.push(e)}}if("always"!==r&&("auto"!==r||!/^\s*</.test(e)))return e;var s,o=!1,a=0,l=[],c=new htmlparser.Parser({onopentag:t,onclosetag:n,ontext:i});return c.parseComplete(e),l.join("")}function extractOffsets(e,r){function t(r,t){if("script"===r&&(!t.type||/text\/javascript/.test(t.type.toLowerCase()))){o=!0;var n=e.slice(a,p.endIndex),i=(n.match(/\r\n|\n|\r/g)||[]).length;l+=i,s=null}}function n(e){"script"===e&&o&&(o=!1,a=p.startIndex,s=null)}function i(e){if(o){var r=e.split(/\r\n|\n|\r/);s||r.some(function(e){if(e)return s=/^(\s*)/.exec(e)[1],!0}),r.forEach(function(){l+=1,s?c[l]=s.length:c[l]=0})}}if("always"===r||"auto"===r&&/^\s*</.test(e)){var s,o=!1,a=0,l=0,c=[],p=new htmlparser.Parser({onopentag:t,onclosetag:n,ontext:i});return p.parseComplete(e),c}}function collect(e,r,t,n){if(!t||!isIgnored(e,t))return shjs.test("-e",e)?shjs.test("-d",e)?void shjs.ls(e).forEach(function(i){var s=path.join(e,i);(shjs.test("-d",s)||i.match(n))&&collect(s,r,t,n)}):void r.push(e):void cli.error("Can't open "+e)}function lint(e,r,t,n,i){var s,o,a=[];t=t||{},t=JSON.parse(JSON.stringify(t)),t.prereq&&(t.prereq.forEach(function(e){e=path.join(t.dirname,e),shjs.test("-e",e)&&a.push(shjs.cat(e))}),delete t.prereq),t.globals&&(s=t.globals,delete t.globals),t.overrides&&(i&&_.each(t.overrides,function(e,r){minimatch(path.normalize(i),r,{nocase:!0,matchBase:!0})&&(e.globals&&(s=_.extend(s||{},e.globals),delete e.globals),_.extend(t,e))}),delete t.overrides),delete t.dirname,a.push(e),a=a.join("\n"),a=a.replace(/^\uFEFF/,""),JSHINT(a,t,s)||JSHINT.errors.forEach(function(e){e&&r.push({file:i||"stdin",error:e})}),o=JSHINT.data(),o&&(o.file=i||"stdin",n.push(o))}var _=require("lodash"),fs=require("fs"),cli=require("cli"),path=require("path"),shjs=require("shelljs"),minimatch=require("minimatch"),htmlparser=require("htmlparser2"),exit=require("exit"),stripJsonComments=require("strip-json-comments"),JSHINT=require("./jshint.js").JSHINT,defReporter=require("./reporters/default").reporter,OPTIONS={config:["c","Custom configuration file","string",!1],reporter:["reporter","Custom reporter (<PATH>|jslint|checkstyle|unix)","string",void 0],prereq:["prereq","Comma-separated list of prerequisites (paths). E.g. files which include definitions of global variables used throughout your project","string",null],exclude:["exclude","Exclude files matching the given filename pattern (same as .jshintignore)","string",null],"exclude-path":["exclude-path","Pass in a custom jshintignore file path","string",null],filename:["filename","Pass in a filename when using STDIN to emulate config lookup for that file name","string",null],verbose:["verbose","Show message codes"],"show-non-errors":["show-non-errors","Show additional data generated by jshint"],"extra-ext":["e","Comma-separated list of file extensions to use (default is .js)","string",""],extract:["extract","Extract inline scripts contained in HTML (auto|always|never, default to never)","string","never"],"jslint-reporter":["jslint-reporter",deprecated("Use a jslint compatible reporter","--reporter=jslint")],"checkstyle-reporter":["checkstyle-reporter",deprecated("Use a CheckStyle compatible XML reporter","--reporter=checkstyle")]},findFileResults={},exports={extract:extract,exit:exit,getConfig:function(e){return loadNpmConfig(e)||exports.loadConfig(findConfig(e))},loadConfig:function(e){if(!e)return{};shjs.test("-e",e)||(cli.error("Can't find config file: "+e),exports.exit(1));try{var r=JSON.parse(stripJsonComments(shjs.cat(e)));if(r.dirname=path.dirname(e),r["extends"]){var t=exports.loadConfig(path.resolve(r.dirname,r["extends"]));r=_.merge({},t,r,function(e,r){if(_.isArray(e))return e.concat(r)}),delete r["extends"]}return r}catch(n){cli.error("Can't parse config file: "+e+"\nError:"+n),exports.exit(1)}},gather:function(e){var r=[],t=new RegExp("\\.(js"+(e.extensions?"|"+e.extensions.replace(/,/g,"|").replace(/[\. ]/g,""):"")+")$"),n=e.ignores?e.ignores.map(function(e){return path.resolve(e)}):loadIgnores({cwd:e.cwd});return e.args.forEach(function(e){collect(e,r,n,t)}),r},run:function(e,r){function t(r){e.prereq&&(r.prereq=(r.prereq||[]).concat(e.prereq.split(/\s*,\s*/)))}var n,i=exports.gather(e),s=[],o=[];return e.filename&&(n=path.resolve(e.filename)),e.useStdin&&e.ignores.indexOf(n)===-1?(cli.withStdin(function(i){var a=e.config;n&&!a&&(a=exports.getConfig(n)),a=a||{},t(a),lint(extract(i,e.extract),s,a,o,n),(e.reporter||defReporter)(s,o,{verbose:e.verbose}),r(0===s.length)}),null):(i.forEach(function(r){var n,i=e.config||exports.getConfig(r),a=[];try{n=shjs.cat(r)}catch(l){cli.error("Can't open "+r),exports.exit(1)}if(t(i),lint(extract(n,e.extract),a,i,o,r),a.length){var c=extractOffsets(n,e.extract);c&&c.length&&a.forEach(function(e){var r=e.error.line;r>=0&&r<c.length&&c[r]&&(e.error.character+=c[r])}),s=s.concat(a)}}),(e.reporter||defReporter)(s,o,{verbose:e.verbose}),0===s.length)},getBufferSize:function(){return process.stdout.bufferSize},interpret:function(e){function r(e){null!=e&&exports.exit(e?0:2)}cli.setArgv(e),cli.options={},cli.enable("version","glob","help"),cli.setApp(path.resolve(__dirname+"/../package.json"));var t,n=cli.parse(OPTIONS);switch(n.config&&(t=exports.loadConfig(n.config)),!0){case"jslint"===n.reporter:case n["jslint-reporter"]:n.reporter="./reporters/jslint_xml.js";break;case"checkstyle"===n.reporter:case n["checkstyle-reporter"]:n.reporter="./reporters/checkstyle.js";break;case"unix"===n.reporter:n.reporter="./reporters/unix.js";break;case n["show-non-errors"]:n.reporter="./reporters/non_error.js";break;case void 0!==n.reporter:n.reporter=path.resolve(process.cwd(),n.reporter)}var i;n.reporter&&(i=loadReporter(n.reporter),null===i&&(cli.error("Can't load reporter file: "+n.reporter),exports.exit(1))),r(exports.run({args:cli.args,config:t,reporter:i,ignores:loadIgnores({exclude:n.exclude,excludePath:n["exclude-path"]}),extensions:n["extra-ext"],verbose:n.verbose,extract:n.extract,filename:n.filename,prereq:n.prereq,useStdin:{"-":!0,"/dev/stdin":!0}[e[e.length-1]]},r))}};module.exports=exports;