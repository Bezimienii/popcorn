"use strict";function isHex(e){return/^[0-9a-fA-F]+$/.test(e)}function isHexDigit(e){return 1===e.length&&isHex(e)}function asyncTrigger(){var e=[];return{push:function(t){e.push(t)},check:function(){for(var t=0;t<e.length;++t)e[t]();e.splice(0,e.length)}}}function Lexer(e){var t=e;"string"==typeof t&&(t=t.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")),t[0]&&"#!"===t[0].substr(0,2)&&(t[0].indexOf("node")!==-1&&(state.option.node=!0),t[0]=""),this.emitter=new events.EventEmitter,this.source=e,this.setLines(t),this.prereg=!0,this.line=0,this["char"]=1,this.from=1,this.input="",this.inComment=!1,this.context=[],this.templateStarts=[];for(var i=0;i<state.option.indent;i+=1)state.tab+=" "}var _=require("lodash"),events=require("events"),reg=require("./reg.js"),state=require("./state.js").state,unicodeData=require("../data/ascii-identifier-data.js"),asciiIdentifierStartTable=unicodeData.asciiIdentifierStartTable,asciiIdentifierPartTable=unicodeData.asciiIdentifierPartTable,nonAsciiIdentifierStartTable=require("../data/non-ascii-identifier-start.js"),nonAsciiIdentifierPartTable=require("../data/non-ascii-identifier-part-only.js"),Token={Identifier:1,Punctuator:2,NumericLiteral:3,StringLiteral:4,Comment:5,Keyword:6,NullLiteral:7,BooleanLiteral:8,RegExp:9,TemplateHead:10,TemplateMiddle:11,TemplateTail:12,NoSubstTemplate:13},Context={Block:1,Template:2};Lexer.prototype={_lines:[],inContext:function(e){return this.context.length>0&&this.context[this.context.length-1].type===e},pushContext:function(e){this.context.push({type:e})},popContext:function(){return this.context.pop()},isContext:function(e){return this.context.length>0&&this.context[this.context.length-1]===e},currentContext:function(){return this.context.length>0&&this.context[this.context.length-1]},getLines:function(){return this._lines=state.lines,this._lines},setLines:function(e){this._lines=e,state.lines=this._lines},peek:function(e){return this.input.charAt(e||0)},skip:function(e){e=e||1,this["char"]+=e,this.input=this.input.slice(e)},on:function(e,t){e.split(" ").forEach(function(e){this.emitter.on(e,t)}.bind(this))},trigger:function(){this.emitter.emit.apply(this.emitter,Array.prototype.slice.call(arguments))},triggerAsync:function(e,t,i,n){i.push(function(){n()&&this.trigger(e,t)}.bind(this))},scanPunctuator:function(){var e,t,i,n=this.peek();switch(n){case".":if(/^[0-9]$/.test(this.peek(1)))return null;if("."===this.peek(1)&&"."===this.peek(2))return{type:Token.Punctuator,value:"..."};case"(":case")":case";":case",":case"[":case"]":case":":case"~":case"?":return{type:Token.Punctuator,value:n};case"{":return this.pushContext(Context.Block),{type:Token.Punctuator,value:n};case"}":return this.inContext(Context.Block)&&this.popContext(),{type:Token.Punctuator,value:n};case"#":return{type:Token.Punctuator,value:n};case"":return null}return e=this.peek(1),t=this.peek(2),i=this.peek(3),">"===n&&">"===e&&">"===t&&"="===i?{type:Token.Punctuator,value:">>>="}:"="===n&&"="===e&&"="===t?{type:Token.Punctuator,value:"==="}:"!"===n&&"="===e&&"="===t?{type:Token.Punctuator,value:"!=="}:">"===n&&">"===e&&">"===t?{type:Token.Punctuator,value:">>>"}:"<"===n&&"<"===e&&"="===t?{type:Token.Punctuator,value:"<<="}:">"===n&&">"===e&&"="===t?{type:Token.Punctuator,value:">>="}:"="===n&&">"===e?{type:Token.Punctuator,value:n+e}:n===e&&"+-<>&|".indexOf(n)>=0?{type:Token.Punctuator,value:n+e}:"<>=!+-*%&|^/".indexOf(n)>=0?"="===e?{type:Token.Punctuator,value:n+e}:{type:Token.Punctuator,value:n}:null},scanComments:function(e){function t(e,t,i){var n=["jshint","jslint","members","member","globals","global","exported"],r=!1,s=e+t,a="plain";return i=i||{},i.isMultiline&&(s+="*/"),t=t.replace(/\n/g," "),"/*"===e&&reg.fallsThrough.test(t)&&(r=!0,a="falls through"),n.forEach(function(i){if(!r&&("//"!==e||"jshint"===i)&&(" "===t.charAt(i.length)&&t.substr(0,i.length)===i&&(r=!0,e+=i,t=t.substr(i.length)),r||" "!==t.charAt(0)||" "!==t.charAt(i.length+1)||t.substr(1,i.length)!==i||(r=!0,e=e+" "+i,t=t.substr(i.length+1)),r))switch(i){case"member":a="members";break;case"global":a="globals";break;default:var n=t.split(":").map(function(e){return e.replace(/^\s+/,"").replace(/\s+$/,"")});if(2===n.length)switch(n[0]){case"ignore":switch(n[1]){case"start":c.ignoringLinterErrors=!0,r=!1;break;case"end":c.ignoringLinterErrors=!1,r=!1}}a=i}}),{type:Token.Comment,commentType:a,value:s,body:t,isSpecial:r,isMultiline:i.isMultiline||!1,isMalformed:i.isMalformed||!1}}var i=this.peek(),n=this.peek(1),r=this.input.substr(2),s=this.line,a=this["char"],c=this;if("*"===i&&"/"===n)return this.trigger("error",{code:"E018",line:s,character:a}),this.skip(2),null;if("/"!==i||"*"!==n&&"/"!==n)return null;if("/"===n)return this.skip(this.input.length),t("//",r);var h="";if("*"===n){for(this.inComment=!0,this.skip(2);"*"!==this.peek()||"/"!==this.peek(1);)if(""===this.peek()){if(h+="\n",!this.nextLine(e))return this.trigger("error",{code:"E017",line:s,character:a}),this.inComment=!1,t("/*",h,{isMultiline:!0,isMalformed:!0})}else h+=this.peek(),this.skip();return this.skip(2),this.inComment=!1,t("/*",h,{isMultiline:!0})}},scanKeyword:function(){var e=/^[a-zA-Z_$][a-zA-Z0-9_$]*/.exec(this.input),t=["if","in","do","var","for","new","try","let","this","else","case","void","with","enum","while","break","catch","throw","const","yield","class","super","return","typeof","delete","switch","export","import","default","finally","extends","function","continue","debugger","instanceof"];return e&&t.indexOf(e[0])>=0?{type:Token.Keyword,value:e[0]}:null},scanIdentifier:function(){function e(e){return nonAsciiIdentifierStartTable.indexOf(e)>-1}function t(t){return e(t)||nonAsciiIdentifierPartTable.indexOf(t)>-1}function i(e){return e.replace(/\\u([0-9a-fA-F]{4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))})}var n,r,s="",a=0,c=function(){if(a+=1,"u"!==this.peek(a))return null;var e,i=this.peek(a+1)+this.peek(a+2)+this.peek(a+3)+this.peek(a+4);return isHex(i)?(e=parseInt(i,16),asciiIdentifierPartTable[e]||t(e)?(a+=5,"\\u"+i):null):null}.bind(this),h=function(){var t=this.peek(a),i=t.charCodeAt(0);return 92===i?c():i<128?asciiIdentifierStartTable[i]?(a+=1,t):null:e(i)?(a+=1,t):null}.bind(this),l=function(){var e=this.peek(a),i=e.charCodeAt(0);return 92===i?c():i<128?asciiIdentifierPartTable[i]?(a+=1,e):null:t(i)?(a+=1,e):null}.bind(this);if(r=h(),null===r)return null;for(s=r;r=l(),null!==r;)s+=r;switch(s){case"true":case"false":n=Token.BooleanLiteral;break;case"null":n=Token.NullLiteral;break;default:n=Token.Identifier}return{type:n,value:i(s),text:s,tokenLength:s.length}},scanNumericLiteral:function(e){function t(e){return/^[0-9]$/.test(e)}function i(e){return/^[0-7]$/.test(e)}function n(e){return/^[01]$/.test(e)}function r(e){return"$"===e||"_"===e||"\\"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}var s,a=0,c="",h=this.input.length,l=this.peek(a),o=t,u=10,p=!1;if("."!==l&&!t(l))return null;if("."!==l){for(c=this.peek(a),a+=1,l=this.peek(a),"0"===c&&("x"!==l&&"X"!==l||(o=isHexDigit,u=16,a+=1,c+=l),"o"!==l&&"O"!==l||(o=i,u=8,state.inES6(!0)||this.triggerAsync("warning",{code:"W119",line:this.line,character:this["char"],data:["Octal integer literal","6"]},e,function(){return!0}),a+=1,c+=l),"b"!==l&&"B"!==l||(o=n,u=2,state.inES6(!0)||this.triggerAsync("warning",{code:"W119",line:this.line,character:this["char"],data:["Binary integer literal","6"]},e,function(){return!0}),a+=1,c+=l),i(l)&&(o=i,u=8,p=!0,s=!1,a+=1,c+=l),!i(l)&&t(l)&&(a+=1,c+=l));a<h;){if(l=this.peek(a),p&&t(l))s=!0;else if(!o(l))break;c+=l,a+=1}if(o!==t)return!p&&c.length<=2?{type:Token.NumericLiteral,value:c,isMalformed:!0}:a<h&&(l=this.peek(a),r(l))?null:{type:Token.NumericLiteral,value:c,base:u,isLegacy:p,isMalformed:!1}}if("."===l)for(c+=l,a+=1;a<h&&(l=this.peek(a),t(l));)c+=l,a+=1;if("e"===l||"E"===l){if(c+=l,a+=1,l=this.peek(a),"+"!==l&&"-"!==l||(c+=this.peek(a),a+=1),l=this.peek(a),!t(l))return null;for(c+=l,a+=1;a<h&&(l=this.peek(a),t(l));)c+=l,a+=1}return a<h&&(l=this.peek(a),r(l))?null:{type:Token.NumericLiteral,value:c,base:u,isMalformed:!isFinite(c)}},scanEscapeSequence:function(e){var t=!1,i=1;this.skip();var n=this.peek();switch(n){case"'":this.triggerAsync("warning",{code:"W114",line:this.line,character:this["char"],data:["\\'"]},e,function(){return state.jsonMode});break;case"b":n="\\b";break;case"f":n="\\f";break;case"n":n="\\n";break;case"r":n="\\r";break;case"t":n="\\t";break;case"0":n="\\0";var r=parseInt(this.peek(1),10);this.triggerAsync("warning",{code:"W115",line:this.line,character:this["char"]},e,function(){return r>=0&&r<=7&&state.isStrict()});break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":n="\\"+n,this.triggerAsync("warning",{code:"W115",line:this.line,character:this["char"]},e,function(){return state.isStrict()});break;case"u":var s=this.input.substr(1,4),a=parseInt(s,16);isHex(s)||this.trigger("warning",{code:"W052",line:this.line,character:this["char"],data:["u"+s]}),n=String.fromCharCode(a),i=5;break;case"v":this.triggerAsync("warning",{code:"W114",line:this.line,character:this["char"],data:["\\v"]},e,function(){return state.jsonMode}),n="\x0B";break;case"x":var c=parseInt(this.input.substr(1,2),16);this.triggerAsync("warning",{code:"W114",line:this.line,character:this["char"],data:["\\x-"]},e,function(){return state.jsonMode}),n=String.fromCharCode(c),i=3;break;case"\\":n="\\\\";break;case'"':n='\\"';break;case"/":break;case"":t=!0,n=""}return{"char":n,jump:i,allowNewLine:t}},scanTemplateLiteral:function(e){var t,i,n="",r=this.line,s=this["char"],a=this.templateStarts.length;if("`"===this.peek())state.inES6(!0)||this.triggerAsync("warning",{code:"W119",line:this.line,character:this["char"],data:["template literal syntax","6"]},e,function(){return!0}),t=Token.TemplateHead,this.templateStarts.push({line:this.line,"char":this["char"]}),a=this.templateStarts.length,this.skip(1),this.pushContext(Context.Template);else{if(!this.inContext(Context.Template)||"}"!==this.peek())return null;t=Token.TemplateMiddle}for(;"`"!==this.peek();){for(;""===(i=this.peek());)if(n+="\n",!this.nextLine(e)){var c=this.templateStarts.pop();return this.trigger("error",{code:"E052",line:c.line,character:c["char"]}),{type:t,value:n,startLine:r,startChar:s,isUnclosed:!0,depth:a,context:this.popContext()}}if("$"===i&&"{"===this.peek(1))return n+="${",this.skip(2),{type:t,value:n,startLine:r,startChar:s,isUnclosed:!1,depth:a,context:this.currentContext()};if("\\"===i){var h=this.scanEscapeSequence(e);n+=h["char"],this.skip(h.jump)}else"`"!==i&&(n+=i,this.skip(1))}return t=t===Token.TemplateHead?Token.NoSubstTemplate:Token.TemplateTail,this.skip(1),this.templateStarts.pop(),{type:t,value:n,startLine:r,startChar:s,isUnclosed:!1,depth:a,context:this.popContext()}},scanStringLiteral:function(e){var t=this.peek();if('"'!==t&&"'"!==t)return null;this.triggerAsync("warning",{code:"W108",line:this.line,character:this["char"]},e,function(){return state.jsonMode&&'"'!==t});var i="",n=this.line,r=this["char"],s=!1;for(this.skip();this.peek()!==t;)if(""===this.peek()){if(s?(s=!1,this.triggerAsync("warning",{code:"W043",line:this.line,character:this["char"]},e,function(){return!state.option.multistr}),this.triggerAsync("warning",{code:"W042",line:this.line,character:this["char"]},e,function(){return state.jsonMode&&state.option.multistr})):this.trigger("warning",{code:"W112",line:this.line,character:this["char"]}),!this.nextLine(e))return this.trigger("error",{code:"E029",line:n,character:r}),{type:Token.StringLiteral,value:i,startLine:n,startChar:r,isUnclosed:!0,quote:t}}else{s=!1;var a=this.peek(),c=1;if(a<" "&&this.triggerAsync("warning",{code:"W113",line:this.line,character:this["char"],data:["<non-printable>"]},e,function(){return!0}),"\\"===a){var h=this.scanEscapeSequence(e);a=h["char"],c=h.jump,s=h.allowNewLine}i+=a,this.skip(c)}return this.skip(),{type:Token.StringLiteral,value:i,startLine:n,startChar:r,isUnclosed:!1,quote:t}},scanRegExp:function(e){var t,i,n=0,r=this.input.length,s=this.peek(),a=s,c="",h=[],l=!1,o=!1,u=function(){s<" "&&(l=!0,this.triggerAsync("warning",{code:"W048",line:this.line,character:this["char"]},e,function(){return!0})),"<"===s&&(l=!0,this.triggerAsync("warning",{code:"W049",line:this.line,character:this["char"],data:[s]},e,function(){return!0}))}.bind(this);if(!this.prereg||"/"!==s)return null;for(n+=1,t=!1;n<r;)if(s=this.peek(n),a+=s,c+=s,o)"]"===s&&("\\"===this.peek(n-1)&&"\\"!==this.peek(n-2)||(o=!1)),"\\"===s&&(n+=1,s=this.peek(n),c+=s,a+=s,u()),n+=1;else{if("\\"===s){if(n+=1,s=this.peek(n),c+=s,a+=s,u(),"/"===s){n+=1;continue}if("["===s){n+=1;continue}}if("["!==s){if("/"===s){c=c.substr(0,c.length-1),t=!0,n+=1;break}n+=1}else o=!0,n+=1}if(!t)return this.trigger("error",{code:"E015",line:this.line,character:this.from}),void this.trigger("fatal",{line:this.line,from:this.from});for(;n<r&&(s=this.peek(n),/[gimy]/.test(s));)"y"===s?(state.inES6(!0)||this.triggerAsync("warning",{code:"W119",line:this.line,character:this["char"],data:["Sticky RegExp flag","6"]},e,function(){return!0}),a.indexOf("y")>-1&&(i="Duplicate RegExp flag")):h.push(s),a+=s,n+=1;try{new RegExp(c,h.join(""))}catch(p){i=p.message}return i&&(l=!0,this.trigger("error",{code:"E016",line:this.line,character:this["char"],data:[i]})),{type:Token.RegExp,value:a,flags:h,isMalformed:l}},scanNonBreakingSpaces:function(){return state.option.nonbsp?this.input.search(/(\u00A0)/):-1},scanUnsafeChars:function(){return this.input.search(reg.unsafeChars)},next:function(e){for(this.from=this["char"];/\s/.test(this.peek());)this.from+=1,this.skip();var t=this.scanComments(e)||this.scanStringLiteral(e)||this.scanTemplateLiteral(e);return t?t:(t=this.scanRegExp(e)||this.scanPunctuator()||this.scanKeyword()||this.scanIdentifier()||this.scanNumericLiteral(e),t?(this.skip(t.tokenLength||t.value.length),t):null)},nextLine:function(e){var t;if(this.line>=this.getLines().length)return!1;this.input=this.getLines()[this.line],this.line+=1,this["char"]=1,this.from=1;var i=this.input.trim(),n=function(){return _.some(arguments,function(e){return 0===i.indexOf(e)})},r=function(){return _.some(arguments,function(e){return i.indexOf(e,i.length-e.length)!==-1})};if(this.ignoringLinterErrors===!0&&(n("/*","//")||this.inComment&&r("*/")||(this.input="")),t=this.scanNonBreakingSpaces(),t>=0&&this.triggerAsync("warning",{code:"W125",line:this.line,character:t+1},e,function(){return!0}),this.input=this.input.replace(/\t/g,state.tab),t=this.scanUnsafeChars(),t>=0&&this.triggerAsync("warning",{code:"W100",line:this.line,character:t},e,function(){return!0}),!this.ignoringLinterErrors&&state.option.maxlen&&state.option.maxlen<this.input.length){var s=this.inComment||n.call(i,"//")||n.call(i,"/*"),a=!s||!reg.maxlenException.test(i);a&&this.triggerAsync("warning",{code:"W101",line:this.line,character:this.input.length},e,function(){return!0})}return!0},token:function(){function e(e,t){if(!e.reserved)return!1;var i=e.meta;if(i&&i.isFutureReservedWord&&state.inES5()){if(!i.es5)return!1;if(i.strictOnly&&!state.option.strict&&!state.isStrict())return!1;if(t)return!1}return!0}for(var t,i=asyncTrigger(),n=function(t,n,r,s){var a;if("(endline)"!==t&&"(end)"!==t&&(this.prereg=!1),"(punctuator)"===t){switch(n){case".":case")":case"~":case"#":case"]":case"++":case"--":this.prereg=!1;break;default:this.prereg=!0}a=Object.create(state.syntax[n]||state.syntax["(error)"])}return"(identifier)"===t&&("return"!==n&&"case"!==n&&"yield"!==n&&"typeof"!==n&&"instanceof"!==n||(this.prereg=!0),_.has(state.syntax,n)&&(a=Object.create(state.syntax[n]||state.syntax["(error)"]),e(a,r&&"(identifier)"===t)||(a=null))),"(template)"!==t&&"(template middle)"!==t||(this.prereg=!0),a||(a=Object.create(state.syntax[t])),a.identifier="(identifier)"===t,a.type=a.type||t,a.value=n,a.line=this.line,a.character=this["char"],a.from=this.from,a.identifier&&s&&(a.raw_text=s.text||s.value),s&&s.startLine&&s.startLine!==this.line&&(a.startLine=s.startLine),s&&s.context&&(a.context=s.context),s&&s.depth&&(a.depth=s.depth),s&&s.isUnclosed&&(a.isUnclosed=s.isUnclosed),r&&a.identifier&&(a.isProperty=r),a.check=i.check,a}.bind(this);;){if(!this.input.length)return this.nextLine(i)?n("(endline)",""):this.exhausted?null:(this.exhausted=!0,n("(end)",""));if(t=this.next(i))switch(t.type){case Token.StringLiteral:return this.triggerAsync("String",{line:this.line,"char":this["char"],from:this.from,startLine:t.startLine,startChar:t.startChar,value:t.value,quote:t.quote},i,function(){return!0}),n("(string)",t.value,null,t);case Token.TemplateHead:return this.trigger("TemplateHead",{line:this.line,"char":this["char"],from:this.from,startLine:t.startLine,startChar:t.startChar,value:t.value}),n("(template)",t.value,null,t);case Token.TemplateMiddle:return this.trigger("TemplateMiddle",{line:this.line,"char":this["char"],from:this.from,startLine:t.startLine,startChar:t.startChar,value:t.value}),n("(template middle)",t.value,null,t);case Token.TemplateTail:return this.trigger("TemplateTail",{line:this.line,"char":this["char"],from:this.from,startLine:t.startLine,startChar:t.startChar,value:t.value}),n("(template tail)",t.value,null,t);case Token.NoSubstTemplate:return this.trigger("NoSubstTemplate",{line:this.line,"char":this["char"],from:this.from,startLine:t.startLine,startChar:t.startChar,value:t.value}),n("(no subst template)",t.value,null,t);case Token.Identifier:this.triggerAsync("Identifier",{line:this.line,"char":this["char"],from:this.from,name:t.value,raw_name:t.text,isProperty:"."===state.tokens.curr.id},i,function(){return!0});case Token.Keyword:case Token.NullLiteral:case Token.BooleanLiteral:return n("(identifier)",t.value,"."===state.tokens.curr.id,t);case Token.NumericLiteral:return t.isMalformed&&this.trigger("warning",{code:"W045",line:this.line,character:this["char"],data:[t.value]}),this.triggerAsync("warning",{code:"W114",line:this.line,character:this["char"],data:["0x-"]},i,function(){return 16===t.base&&state.jsonMode}),this.triggerAsync("warning",{code:"W115",line:this.line,character:this["char"]},i,function(){return state.isStrict()&&8===t.base&&t.isLegacy}),this.trigger("Number",{line:this.line,"char":this["char"],from:this.from,value:t.value,base:t.base,isMalformed:t.malformed}),n("(number)",t.value);case Token.RegExp:return n("(regexp)",t.value);case Token.Comment:if(state.tokens.curr.comment=!0,t.isSpecial)return{id:"(comment)",value:t.value,body:t.body,type:t.commentType,isSpecial:t.isSpecial,line:this.line,character:this["char"],from:this.from};break;case"":break;default:return n("(punctuator)",t.value)}else this.input.length&&(this.trigger("error",{code:"E024",line:this.line,character:this["char"],data:[this.peek()]}),this.input="")}}},exports.Lexer=Lexer,exports.Context=Context;