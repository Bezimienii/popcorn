function read(e,n){return MontageBootstrap.loadPackage(e,n).then(function(e){return loadDeepPackages(e).then(verifyVersions).then(function(){var r=Object.values(e.packages);return n.files={},Promise.each(r,function(e){return e.files={},readPackage(e,n)}).then(function(){return hashDependencies(e)}).then(function(){return e})})})}function verifyVersions(e){return new Promise(function(n,r){if(e.hasPackage({name:"montage"})){var a=e.getPackage({name:"montage"}),t=mopDescription.dependencies.montage;if(!semver.satisfies(a.packageDescription.version,t))return void r(new Error("Mop only supports Montage "+t+".  This app has "+a.packageDescription.version))}if(e.hasPackage({name:"mr"})){var i=e.getPackage({name:"mr"}),o=mopDescription.dependencies.mr;if(!semver.satisfies(i.packageDescription.version,o))return void r(new Error("Mop only supports Montage Require (mr) "+o+".  This app has "+i.packageDescription.version))}return n(e)})}function loadDeepPackages(e,n){n=n||{};var r=e.mappings||{};return Promise.all(Object.keys(r).map(function(a){var t=r[a],i=t.location;if(!n[i]){var o=e.loadPackage(i).then(function(e){return loadDeepPackages(e,n)});return n[i]=o,o}})).then(function(){return e})}function readPackage(e,n,r){r=r||{};var a=e.location,t=Hash("sha256");e.hashBuilder=t,t.update(mopDescription.version),t.update(n.seed||""),t.update([n.minify,n.appcache,n.shared].map(function(e){return e?"1":"0"}).join("")),t.update(n.delimiter||"@");var i=Location.toPath(a),o=Glob.makeFilter(i,e.config.packageDescription.exclude);return n.fs.listTree(i,function(e,r){return n.out.status("Reading package",e),e!==i&&r.isDirectory()?n.fs.isFile(path.join(e,"package.json")).then(function(n){return n?null:o(e,r)}):o(e,r)}).then(function(r){return n.out.status(),Promise.each(r,function(r){n.out.status("Reading files",r);var i=URL.resolve(n.location,Location.fromPath(r)),o=URL.relative(a,i);return n.fs.read(r).then(function(a){t.update(o),t.update(a);var s=new File({fs:n.fs,location:i,relativeLocation:o,"package":e,path:r});e.files[o]=s,n.files[i]=s,transform.extensions[n.fs.extension(i)]&&(s.buffer=a)})})}).then(function(){n.out.status()})}function hashDependencies(e,n){if(n=n||{},!n[e.location]){n[e.location]=!0;var r=e.mappings,a=Object.keys(r).sort().map(function(n){var a=r[n].location;return e.packages[a]});return Promise.all(a.map(function(e){return hashDependencies(e,n)})).then(function(){a.forEach(function(n){e.hashBuilder.update(n.hash||"")}),e.hash=e.hashBuilder.digest().slice(0,7)})}}var MontageBootstrap=require("montage"),Promise=require("bluebird"),URL=require("url2"),semver=require("semver"),Hash=require("./hash"),File=require("./file"),Glob=require("./glob"),transform=require("./transform"),Location=require("./location"),mopDescription=require("../package.json"),path=require("path");module.exports=read;