montageDefine("5f1e513","lib/bundle",{dependencies:["bluebird","url2","./shim-minidom","minidom/dom","./minify-javascript","./file","./location","./bundle/mr","./bundle/montage"],factory:function(e,t,n){function a(e,t){return d.each(Object.values(e.files),function(e){var n=t.fs.extension(m.toPath(e.location));if(".html"===n)return t.out.status("Bundling",e.location),r(e,t)}).then(function(){t.out.status()})["catch"](function(e){console.error(e)})}function r(e,t){var n,a,r,o,i,u=e["package"],c=[];u.hasPackage({name:"montage"})?(n=u.getPackage({name:"montage"}),a=n.files["montage.js"].buildLocation):u.hasPackage({name:"mr"})&&(r=u.getPackage({name:"mr"}),o=r.files["bootstrap.js"].buildLocation);try{i=e.document}catch(l){return t.out.warn("HTML parse error: "+e.path),void t.out.warn(l.message)}return f(i,function(n){if(n.nodeType===g.ELEMENT_NODE&&"SCRIPT"===n.tagName&&n.hasAttribute("src")){var r=n.getAttribute("src"),i=p.resolve(e.buildLocation,r);i===a?c.push(k.bind(null,n,e,t)):i===o&&c.push(v.bind(null,n,e,t))}}),d.each(c,d["try"])}function o(e,t,n){var a;if(e.hasAttribute("data-package")){if(a=e.getAttribute("data-package"),/\/$/.test(a)||(a+="/"),a=p.resolve(t.buildLocation,a),a!==t["package"].buildLocation)return n.out.warn("Montage bootstrapping script reports innacurate data-package location."),n.out.warn("In file: "+t.path),n.out.warn("Expected: "+t["package"].buildLocation),n.out.warn("Actual: "+a),e.getAttribute("src")}else e.hasAttribute("data-auto-package")||(a=p.resolve(t.buildLocation,"./"),a!==t["package"].buildLocation&&(n.out.warn("Montage bootstrapping script needs a data-package attribute."),n.out.warn("In file: "+t.path),n.out.warn("Expected: "+p.relative(t.location,t["package"].location))))}function i(e,t,n){var a,r=t.packageDescription.bundle;if(null==r||"boolean"==typeof r)a=[];else{if(!Array.isArray(r))throw new Error('package.json "bundle" must be true or an array of bundle module identifiers. Got: '+t.packageDescription.bundle);a=r.map(function(e){if("string"==typeof e)return[[e]];if(Array.isArray(e))return e.map(function(e){if("string"==typeof e)return[e];if(Array.isArray(e))return e;throw new Error('Every batch in package.json "bundle" array must be a module identifier or an array of identifiers.')});throw new Error('Every batch in package.json "bundle" array must be either a module identifier or array of module identifiers')})}var o=[];return d.each(a,function(a){return d.each(a,function(t){return d.each(t,function(t){return e.deepLoad(t)["catch"](function(n){throw n.message="Can't collect the dependencies of "+JSON.stringify(t)+" in package "+e.location+" because "+n.message,n})})}).then(function(){var a=u(e,t,n);o.push(a)})}).then(function(){return o.map(function(t){return s(t,e.packageDescription.shard||e.packageDescription.shards||1)})})}function u(e,t,n,a){return a=a||[],Object.forEach(e.packages,function(e,n){if(!e.bundled){e.bundled=!0;var r=t.getPackage(n);a.push(r.files["package.json.load.js"].utf8)}}),Object.forEach(e.packages,function(e,r){var o=t.getPackage(r);Object.forEach(e.modules,function(e,t){if(!e.bundled&&(e.bundled=!0,void 0!==e.location&&"javascript"===e.type)){var r=p.resolve(o.location,t+".load.js");n.files[r]&&a.push(n.files[r].utf8)}})}),a}function c(e,t,n){return e.map(function(e,a){return e.map(function(e,r){var o=l(e,t,n,"bundle-"+(a+1)+"-"+r),i=p.relative(p.resolve(o.relativeLocation,"./"),o.relativeLocation);return o.utf8+="\nbundleLoaded("+JSON.stringify(i)+")",o})})}function l(e,t,n,a){a=a?"."+a:"",e=e.join("\n;\n//*/\n"),n.minify&&(e=b(e));var r=t.relativeLocation+a+".js",o=p.resolve(t["package"].buildLocation,r);return t=new h({fs:n.fs,utf8:e,buildLocation:o,relativeLocation:r,"package":t["package"]}),n.files[o]=t,t}function s(e,t){var n,a,r=[];for(n=0;n<t;n++)r.push({length:0,parts:[]});for(e.sort(L),n=0;n<e.length;n++)a=e[n],r[0].parts.push(a),r[0].length+=a.length,r.sort(y);return r.filter(function(e){return e.length}).map(function(e){return e.parts})}function f(e,t){for(t(e),e=e.firstChild;e;)f(e,t),e=e.nextSibling}n.exports=a;var d=e("bluebird"),p=e("url2");e("./shim-minidom");var g=e("minidom/dom").Node,b=e("./minify-javascript"),h=e("./file"),m=e("./location"),v=e("./bundle/mr"),k=e("./bundle/montage");a.verifyPackageLocation=o,a.collectPreloadBundles=i,a.collectBundle=u,a.createPreloadBundles=c,a.createBundle=l;var y=function(e,t){return e.length-t.length},L=function(e,t){return-(e.length-t.length)}}});