function bundleMrHtml(e,t,a){return Bundle.verifyPackageLocation(e,t,a),loadMrScript(e,t,a).then(function(r){var n=collectMrBootstrapBundle(r,t["package"],a);return Bundle.collectPreloadBundles(r,t["package"],a).then(function(r){var u=Bundle.createPreloadBundles(r,t,a);bundleMrScript(n,u,e,t,a)})})}function loadMrScript(e,t,a){if(!e.hasAttribute("data-module"))throw new Error("Element needs data-module attribute in "+JSON.stringify(t.path));var r=t["package"].location;return MrBootstrap.loadPackage(r,a).then(function(a){return a.loadPackage({name:"mr"}).then(function(e){return e.loadPackage({name:"bluebird"})}).then(function(){return a.deepLoad(e.getAttribute("data-module"))})["catch"](function(e){throw e.message="Can't find dependencies of Mr module in "+JSON.stringify(t.path)+" because "+e.message,e}).then(function(){return a})},function(e){throw e.message="Can't load package in "+JSON.stringify(t.path)+" because "+e.message,e})}function collectMrBootstrapBundle(e,t,a){var r=t.getPackage({name:"mr"}),n=t.getPackage({name:"bluebird"}),u=[r.files["bootstrap.js"].utf8,r.files["require.js"].utf8,r.files["browser.js"].utf8,n.files["js/browser/bluebird.min.js"].utf8];return e.getPackage({name:"bluebird"}).getModuleDescriptor("bluebird").bundled=!0,Bundle.collectBundle(e,t,a,u)}function bundleMrScript(e,t,a,r,n){var u=t.map(function(e){return e.map(function(e){return n.out.log("Bundle:",e.buildLocation,e.utf8.length,"bytes"),URL.relative(r.buildLocation,e.buildLocation)})});e.unshift("preload="+JSON.stringify(u)+";\n");var i=Bundle.createBundle(e,r,n,"bundle-0");n.out.log("Bundle:",i.buildLocation,i.utf8.length,"bytes (mr bootstrap)");var o=r["package"],l=r["package"].getPackage({name:"mr"}),d=r["package"].getPackage({name:"bluebird"}),c=URL.relative(r.buildLocation,i.buildLocation),s=URL.relative(r.buildLocation,l.buildLocation),b=URL.relative(r.buildLocation,d.buildLocation);a.setAttribute("src",c),a.setAttribute("data-mr-location",s),a.setAttribute("data-bluebird-location",b),a.setAttribute("data-mr-hash",l.hash),a.setAttribute("data-bluebird-hash",d.hash),a.setAttribute("data-application-hash",o.hash)}var Bundle=require("../bundle"),MrBootstrap=require("mr/bootstrap-node"),URL=require("url2");module.exports=bundleMrHtml;