montageDefine("5f1e513","lib/read",{dependencies:["montage","bluebird","url2","semver","./hash","./file","./glob","./transform","./location","../package.json","path"],factory:function(e,n,t){function a(e,n){return u.loadPackage(e,n).then(function(e){return i(e).then(r).then(function(){var t=Object.values(e.packages);return n.files={},c.each(t,function(e){return e.files={},o(e,n)}).then(function(){return s(e)}).then(function(){return e})})})}function r(e){return new c(function(n,t){if(e.hasPackage({name:"montage"})){var a=e.getPackage({name:"montage"}),r=v.dependencies.montage;if(!p.satisfies(a.packageDescription.version,r))return void t(new Error("Mop only supports Montage "+r+".  This app has "+a.packageDescription.version))}if(e.hasPackage({name:"mr"})){var i=e.getPackage({name:"mr"}),o=v.dependencies.mr;if(!p.satisfies(i.packageDescription.version,o))return void t(new Error("Mop only supports Montage Require (mr) "+o+".  This app has "+i.packageDescription.version))}return n(e)})}function i(e,n){n=n||{};var t=e.mappings||{};return c.all(Object.keys(t).map(function(a){var r=t[a],o=r.location;if(!n[o]){var s=e.loadPackage(o).then(function(e){return i(e,n)});return n[o]=s,s}})).then(function(){return e})}function o(e,n,t){t=t||{};var a=e.location,r=l("sha256");e.hashBuilder=r,r.update(v.version),r.update(n.seed||""),r.update([n.minify,n.appcache,n.shared].map(function(e){return e?"1":"0"}).join("")),r.update(n.delimiter||"@");var i=m.toPath(a),o=g.makeFilter(i,e.config.packageDescription.exclude);return n.fs.listTree(i,function(e,t){return n.out.status("Reading package",e),e!==i&&t.isDirectory()?n.fs.isFile(k.join(e,"package.json")).then(function(n){return n?null:o(e,t)}):o(e,t)}).then(function(t){return n.out.status(),c.each(t,function(t){n.out.status("Reading files",t);var i=f.resolve(n.location,m.fromPath(t)),o=f.relative(a,i);return n.fs.read(t).then(function(a){r.update(o),r.update(a);var s=new h({fs:n.fs,location:i,relativeLocation:o,"package":e,path:t});e.files[o]=s,n.files[i]=s,d.extensions[n.fs.extension(i)]&&(s.buffer=a)})})}).then(function(){n.out.status()})}function s(e,n){if(n=n||{},!n[e.location]){n[e.location]=!0;var t=e.mappings,a=Object.keys(t).sort().map(function(n){var a=t[n].location;return e.packages[a]});return c.all(a.map(function(e){return s(e,n)})).then(function(){a.forEach(function(n){e.hashBuilder.update(n.hash||"")}),e.hash=e.hashBuilder.digest().slice(0,7)})}}var u=e("montage"),c=e("bluebird"),f=e("url2"),p=e("semver"),l=e("./hash"),h=e("./file"),g=e("./glob"),d=e("./transform"),m=e("./location"),v=e("../package.json"),k=e("path");t.exports=a}});