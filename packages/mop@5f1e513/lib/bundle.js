function bundle(e,t){return Promise.each(Object.values(e.files),function(e){var n=t.fs.extension(Location.toPath(e.location));if(".html"===n)return t.out.status("Bundling",e.location),bundleHtml(e,t)}).then(function(){t.out.status()})["catch"](function(e){console.error(e)})}function bundleHtml(e,t){var n,a,r,i,o,u=e["package"],c=[];u.hasPackage({name:"montage"})?(n=u.getPackage({name:"montage"}),a=n.files["montage.js"].buildLocation):u.hasPackage({name:"mr"})&&(r=u.getPackage({name:"mr"}),i=r.files["bootstrap.js"].buildLocation);try{o=e.document}catch(l){return t.out.warn("HTML parse error: "+e.path),void t.out.warn(l.message)}return visit(o,function(n){if(n.nodeType===Node.ELEMENT_NODE&&"SCRIPT"===n.tagName&&n.hasAttribute("src")){var r=n.getAttribute("src"),o=URL.resolve(e.buildLocation,r);o===a?c.push(bundleMontageHtml.bind(null,n,e,t)):o===i&&c.push(bundleMrHtml.bind(null,n,e,t))}}),Promise.each(c,Promise["try"])}function verifyPackageLocation(e,t,n){var a;if(e.hasAttribute("data-package")){if(a=e.getAttribute("data-package"),/\/$/.test(a)||(a+="/"),a=URL.resolve(t.buildLocation,a),a!==t["package"].buildLocation)return n.out.warn("Montage bootstrapping script reports innacurate data-package location."),n.out.warn("In file: "+t.path),n.out.warn("Expected: "+t["package"].buildLocation),n.out.warn("Actual: "+a),e.getAttribute("src")}else e.hasAttribute("data-auto-package")||(a=URL.resolve(t.buildLocation,"./"),a!==t["package"].buildLocation&&(n.out.warn("Montage bootstrapping script needs a data-package attribute."),n.out.warn("In file: "+t.path),n.out.warn("Expected: "+URL.relative(t.location,t["package"].location))))}function collectPreloadBundles(e,t,n){var a,r=t.packageDescription.bundle;if(null==r||"boolean"==typeof r)a=[];else{if(!Array.isArray(r))throw new Error('package.json "bundle" must be true or an array of bundle module identifiers. Got: '+t.packageDescription.bundle);a=r.map(function(e){if("string"==typeof e)return[[e]];if(Array.isArray(e))return e.map(function(e){if("string"==typeof e)return[e];if(Array.isArray(e))return e;throw new Error('Every batch in package.json "bundle" array must be a module identifier or an array of identifiers.')});throw new Error('Every batch in package.json "bundle" array must be either a module identifier or array of module identifiers')})}var i=[];return Promise.each(a,function(a){return Promise.each(a,function(t){return Promise.each(t,function(t){return e.deepLoad(t)["catch"](function(n){throw n.message="Can't collect the dependencies of "+JSON.stringify(t)+" in package "+e.location+" because "+n.message,n})})}).then(function(){var a=collectBundle(e,t,n);i.push(a)})}).then(function(){return i.map(function(t){return shardBundle(t,e.packageDescription.shard||e.packageDescription.shards||1)})})}function collectBundle(e,t,n,a){return a=a||[],Object.forEach(e.packages,function(e,n){if(!e.bundled){e.bundled=!0;var r=t.getPackage(n);a.push(r.files["package.json.load.js"].utf8)}}),Object.forEach(e.packages,function(e,r){var i=t.getPackage(r);Object.forEach(e.modules,function(e,t){if(!e.bundled&&(e.bundled=!0,void 0!==e.location&&"javascript"===e.type)){var r=URL.resolve(i.location,t+".load.js");n.files[r]&&a.push(n.files[r].utf8)}})}),a}function createPreloadBundles(e,t,n){return e.map(function(e,a){return e.map(function(e,r){var i=createBundle(e,t,n,"bundle-"+(a+1)+"-"+r),o=URL.relative(URL.resolve(i.relativeLocation,"./"),i.relativeLocation);return i.utf8+="\nbundleLoaded("+JSON.stringify(o)+")",i})})}function createBundle(e,t,n,a){a=a?"."+a:"",e=e.join("\n;\n//*/\n"),n.minify&&(e=minifyJavaScript(e));var r=t.relativeLocation+a+".js",i=URL.resolve(t["package"].buildLocation,r);return t=new File({fs:n.fs,utf8:e,buildLocation:i,relativeLocation:r,"package":t["package"]}),n.files[i]=t,t}function shardBundle(e,t){var n,a,r=[];for(n=0;n<t;n++)r.push({length:0,parts:[]});for(e.sort(byDescendingLength),n=0;n<e.length;n++)a=e[n],r[0].parts.push(a),r[0].length+=a.length,r.sort(byLength);return r.filter(function(e){return e.length}).map(function(e){return e.parts})}function visit(e,t){for(t(e),e=e.firstChild;e;)visit(e,t),e=e.nextSibling}module.exports=bundle;var Promise=require("bluebird"),URL=require("url2");require("./shim-minidom");var Node=require("minidom/dom").Node,minifyJavaScript=require("./minify-javascript"),File=require("./file"),Location=require("./location"),bundleMrHtml=require("./bundle/mr"),bundleMontageHtml=require("./bundle/montage");bundle.verifyPackageLocation=verifyPackageLocation,bundle.collectPreloadBundles=collectPreloadBundles,bundle.collectBundle=collectBundle,bundle.createPreloadBundles=createPreloadBundles,bundle.createBundle=createBundle;var byLength=function(e,t){return e.length-t.length},byDescendingLength=function(e,t){return-(e.length-t.length)};