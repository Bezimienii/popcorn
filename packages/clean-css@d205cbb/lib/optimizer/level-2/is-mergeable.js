function isMergeable(e,r,O,E){var n,t,i,_=split(e,Marker.COMMA);for(t=0,i=_.length;t<i;t++)if(n=_[t],0===n.length||isDeepSelector(n)||n.indexOf(Marker.COLON)>-1&&!areMergeable(n,extractPseudoFrom(n),r,O,E))return!1;return!0}function isDeepSelector(e){return DEEP_SELECTOR_PATTERN.test(e)}function extractPseudoFrom(e){var r,O,E,n,t,i,_=[],l=[],u=Level.ROOT,T=0,s=!1,a=!1;for(t=0,i=e.length;t<i;t++)r=e[t],n=!E&&RELATION_PATTERN.test(r),O=u==Level.DOUBLE_QUOTE||u==Level.SINGLE_QUOTE,E?l.push(r):r==Marker.DOUBLE_QUOTE&&u==Level.ROOT?(l.push(r),u=Level.DOUBLE_QUOTE):r==Marker.DOUBLE_QUOTE&&u==Level.DOUBLE_QUOTE?(l.push(r),u=Level.ROOT):r==Marker.SINGLE_QUOTE&&u==Level.ROOT?(l.push(r),u=Level.SINGLE_QUOTE):r==Marker.SINGLE_QUOTE&&u==Level.SINGLE_QUOTE?(l.push(r),u=Level.ROOT):O?l.push(r):r==Marker.OPEN_ROUND_BRACKET?(l.push(r),T++):r==Marker.CLOSE_ROUND_BRACKET&&1==T&&s?(l.push(r),_.push(l.join("")),T--,l=[],s=!1):r==Marker.CLOSE_ROUND_BRACKET?(l.push(r),T--):r==Marker.COLON&&0===T&&s&&!a?(_.push(l.join("")),l=[],l.push(r)):r!=Marker.COLON||0!==T||a?r==Marker.SPACE&&0===T&&s?(_.push(l.join("")),l=[],s=!1):n&&0===T&&s?(_.push(l.join("")),l=[],s=!1):l.push(r):(l=[],l.push(r),s=!0),E=r==Marker.BACK_SLASH,a=r==Marker.COLON;return l.length>0&&s&&_.push(l.join("")),_}function areMergeable(e,r,O,E,n){return areAllowed(r,O,E)&&needArguments(r)&&(r.length<2||!someIncorrectlyChained(e,r))&&(r.length<2||n&&allMixable(r))}function areAllowed(e,r,O){var E,n,t,i;for(t=0,i=e.length;t<i;t++)if(E=e[t],n=E.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?E.substring(0,E.indexOf(Marker.OPEN_ROUND_BRACKET)):E,r.indexOf(n)===-1&&O.indexOf(n)===-1)return!1;return!0}function needArguments(e){var r,O,E,n,t,i;for(t=0,i=e.length;t<i;t++){if(r=e[t],E=r.indexOf(Marker.OPEN_ROUND_BRACKET),n=E>-1,O=n?r.substring(0,E):r,n&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(O)==-1)return!1;if(!n&&PSEUDO_CLASSES_WITH_ARGUMENTS.indexOf(O)>-1)return!1}return!0}function someIncorrectlyChained(e,r){var O,E,n,t,i,_,l,u,T,s=0;for(u=0,T=r.length;u<T&&(O=r[u],n=r[u+1],n);u++)if(E=e.indexOf(O,s),t=e.indexOf(O,E+1),s=t,l=E+O.length==t,l&&(i=O.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?O.substring(0,O.indexOf(Marker.OPEN_ROUND_BRACKET)):O,_=n.indexOf(Marker.OPEN_ROUND_BRACKET)>-1?n.substring(0,n.indexOf(Marker.OPEN_ROUND_BRACKET)):n,i!=NOT_PSEUDO||_!=NOT_PSEUDO))return!0;return!1}function allMixable(e){var r,O,E,n=0;for(O=0,E=e.length;O<E;O++)if(r=e[O],n+=isPseudoElement(r)?UNMIXABLE_PSEUDO_ELEMENTS.indexOf(r)>-1?1:0:UNMIXABLE_PSEUDO_CLASSES.indexOf(r)>-1?1:0,n>1)return!1;return!0}function isPseudoElement(e){return DOUBLE_COLON_PATTERN.test(e)}var Marker=require("../../tokenizer/marker"),split=require("../../utils/split"),DEEP_SELECTOR_PATTERN=/\/deep\//,DOUBLE_COLON_PATTERN=/^::/,NOT_PSEUDO=":not",PSEUDO_CLASSES_WITH_ARGUMENTS=[":dir",":lang",":not",":nth-child",":nth-last-child",":nth-last-of-type",":nth-of-type"],RELATION_PATTERN=/[>\+~]/,UNMIXABLE_PSEUDO_CLASSES=[":after",":before",":first-letter",":first-line",":lang"],UNMIXABLE_PSEUDO_ELEMENTS=["::after","::before","::first-letter","::first-line"],Level={DOUBLE_QUOTE:"double-quote",SINGLE_QUOTE:"single-quote",ROOT:"root"};module.exports=isMergeable;