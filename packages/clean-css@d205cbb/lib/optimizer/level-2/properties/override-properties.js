function wouldBreakCompatibility(e,n){for(var r=0;r<e.components.length;r++){var o=e.components[r],i=compactable[o.name],t=i&&i.canOverride||t.sameValue,a=shallowClone(o);if(a.value=[[Token.PROPERTY_VALUE,i.defaultValue]],!everyValuesPair(t.bind(null,n),a,o))return!0}return!1}function overrideIntoMultiplex(e,n){n.unused=!0,turnIntoMultiplex(n,multiplexSize(e)),e.value=n.value}function overrideByMultiplex(e,n){n.unused=!0,e.multiplex=!0,e.value=n.value}function overrideSimple(e,n){n.unused=!0,e.value=n.value}function override(e,n){n.multiplex?overrideByMultiplex(e,n):e.multiplex?overrideIntoMultiplex(e,n):overrideSimple(e,n)}function overrideShorthand(e,n){n.unused=!0;for(var r=0,o=e.components.length;r<o;r++)override(e.components[r],n.components[r],e.multiplex)}function turnIntoMultiplex(e,n){e.multiplex=!0,compactable[e.name].shorthand?turnShorthandValueIntoMultiplex(e,n):turnLonghandValueIntoMultiplex(e,n)}function turnShorthandValueIntoMultiplex(e,n){var r,o,i;for(o=0,i=e.components.length;o<i;o++)r=e.components[o],r.multiplex||turnLonghandValueIntoMultiplex(r,n)}function turnLonghandValueIntoMultiplex(e,n){for(var r,o="real"==compactable[e.name].intoMultiplexMode,i=o?e.value.slice(0):compactable[e.name].defaultValue,t=multiplexSize(e),a=i.length;t<n;t++)if(e.value.push([Token.PROPERTY_VALUE,Marker.COMMA]),Array.isArray(i))for(r=0;r<a;r++)e.value.push(o?i[r]:[Token.PROPERTY_VALUE,i[r]]);else e.value.push(o?i:[Token.PROPERTY_VALUE,i])}function multiplexSize(e){for(var n=0,r=0,o=e.value.length;r<o;r++)e.value[r][1]==Marker.COMMA&&n++;return n+1}function lengthOf(e){var n=[Token.PROPERTY,[Token.PROPERTY_NAME,e.name]].concat(e.value);return serializeProperty([n],0).length}function moreSameShorthands(e,n,r){for(var o=0,i=n;i>=0&&(e[i].name!=r||e[i].unused||o++,!(o>1));i--);return o>1}function overridingFunction(e,n){for(var r=0,o=e.components.length;r<o;r++)if(!anyValue(n.isUrl,e.components[r])&&anyValue(n.isFunction,e.components[r]))return!0;return!1}function anyValue(e,n){for(var r=0,o=n.value.length;r<o;r++)if(n.value[r][1]!=Marker.COMMA&&e(n.value[r][1]))return!0;return!1}function wouldResultInLongerValue(e,n){if(!e.multiplex&&!n.multiplex||e.multiplex&&n.multiplex)return!1;var r,o=e.multiplex?e:n,i=e.multiplex?n:e,t=deepClone(o);restoreFromOptimizing([t],restoreWithComponents);var a=deepClone(i);restoreFromOptimizing([a],restoreWithComponents);var u=lengthOf(t)+1+lengthOf(a);e.multiplex?(r=findComponentIn(t,a),overrideIntoMultiplex(r,a)):(r=findComponentIn(a,t),turnIntoMultiplex(a,multiplexSize(t)),overrideByMultiplex(r,t)),restoreFromOptimizing([a],restoreWithComponents);var l=lengthOf(a);return u<=l}function isCompactable(e){return e.name in compactable}function noneOverrideHack(e,n){return!e.multiplex&&("background"==e.name||"background-image"==e.name)&&n.multiplex&&("background"==n.name||"background-image"==n.name)&&anyLayerIsNone(n.value)}function anyLayerIsNone(e){for(var n=intoLayers(e),r=0,o=n.length;r<o;r++)if(1==n[r].length&&"none"==n[r][0][1])return!0;return!1}function intoLayers(e){for(var n=[],r=0,o=[],i=e.length;r<i;r++){var t=e[r];t[1]==Marker.COMMA?(n.push(o),o=[]):o.push(t)}return n.push(o),n}function overrideProperties(e,n,r,o){var i,t,a,u,l,m,p,c,s,d,f;e:for(s=e.length-1;s>=0;s--)if(t=e[s],isCompactable(t)&&!t.block){i=compactable[t.name].canOverride;n:for(d=s-1;d>=0;d--)if(a=e[d],isCompactable(a)&&!a.block&&!a.unused&&!t.unused&&(!a.hack||t.hack||t.important)&&(a.hack||a.important||!t.hack)&&(a.important!=t.important||a.hack[0]==t.hack[0])&&!(a.important==t.important&&(a.hack[0]!=t.hack[0]||a.hack[1]&&a.hack[1]!=t.hack[1])||hasInherit(t)||noneOverrideHack(a,t)))if(t.shorthand&&isComponentOf(t,a)){if(!t.important&&a.important)continue;if(!sameVendorPrefixesIn([a],t.components))continue;if(!anyValue(o.isFunction,a)&&overridingFunction(t,o))continue;if(!isMergeableShorthand(t)){a.unused=!0;continue}u=findComponentIn(t,a),i=compactable[a.name].canOverride,everyValuesPair(i.bind(null,o),a,u)&&(a.unused=!0)}else if(t.shorthand&&overridesNonComponentShorthand(t,a)){if(!t.important&&a.important)continue;if(!sameVendorPrefixesIn([a],t.components))continue;if(!anyValue(o.isFunction,a)&&overridingFunction(t,o))continue;for(l=a.shorthand?a.components:[a],f=l.length-1;f>=0;f--)if(m=l[f],p=findComponentIn(t,m),i=compactable[m.name].canOverride,!everyValuesPair(i.bind(null,o),a,p))continue n;a.unused=!0}else if(n&&a.shorthand&&!t.shorthand&&isComponentOf(a,t,!0)){if(t.important&&!a.important)continue;if(!t.important&&a.important){t.unused=!0;continue}if(moreSameShorthands(e,s-1,a.name))continue;if(overridingFunction(a,o))continue;if(!isMergeableShorthand(a))continue;if(u=findComponentIn(a,t),everyValuesPair(i.bind(null,o),u,t)){var h=!r.properties.backgroundClipMerging&&u.name.indexOf("background-clip")>-1||!r.properties.backgroundOriginMerging&&u.name.indexOf("background-origin")>-1||!r.properties.backgroundSizeMerging&&u.name.indexOf("background-size")>-1,v=compactable[t.name].nonMergeableValue===t.value[0][1];if(h||v)continue;if(!r.properties.merging&&wouldBreakCompatibility(a,o))continue;if(u.value[0][1]!=t.value[0][1]&&(hasInherit(a)||hasInherit(t)))continue;if(wouldResultInLongerValue(a,t))continue;!a.multiplex&&t.multiplex&&turnIntoMultiplex(a,multiplexSize(t)),override(u,t),a.dirty=!0}}else if(n&&a.shorthand&&t.shorthand&&a.name==t.name){if(!a.multiplex&&t.multiplex)continue;if(!t.important&&a.important){t.unused=!0;continue e}if(t.important&&!a.important){a.unused=!0;continue}if(!isMergeableShorthand(t)){a.unused=!0;continue}for(f=a.components.length-1;f>=0;f--){var g=a.components[f],b=t.components[f];if(i=compactable[g.name].canOverride,!everyValuesPair(i.bind(null,o),g,b))continue e}overrideShorthand(a,t),a.dirty=!0}else if(n&&a.shorthand&&t.shorthand&&isComponentOf(a,t)){if(!a.important&&t.important)continue;if(u=findComponentIn(a,t),i=compactable[t.name].canOverride,!everyValuesPair(i.bind(null,o),u,t))continue;if(a.important&&!t.important){t.unused=!0;continue}var x=compactable[t.name].restore(t,compactable);if(x.length>1)continue;u=findComponentIn(a,t),override(u,t),t.dirty=!0}else if(a.name==t.name){if(c=!0,t.shorthand)for(f=t.components.length-1;f>=0&&c;f--)m=a.components[f],p=t.components[f],i=compactable[p.name].canOverride,c=c&&everyValuesPair(i.bind(null,o),m,p);else i=compactable[t.name].canOverride,c=everyValuesPair(i.bind(null,o),a,t);if(a.important&&!t.important&&c){t.unused=!0;continue}if(!a.important&&t.important&&c){a.unused=!0;continue}if(!c)continue;a.unused=!0}}}var hasInherit=require("./has-inherit"),everyValuesPair=require("./every-values-pair"),findComponentIn=require("./find-component-in"),isComponentOf=require("./is-component-of"),isMergeableShorthand=require("./is-mergeable-shorthand"),overridesNonComponentShorthand=require("./overrides-non-component-shorthand"),sameVendorPrefixesIn=require("./vendor-prefixes").same,compactable=require("../compactable"),deepClone=require("../clone").deep,deepClone=require("../clone").deep,restoreWithComponents=require("../restore-with-components"),shallowClone=require("../clone").shallow,restoreFromOptimizing=require("../../restore-from-optimizing"),Token=require("../../../tokenizer/token"),Marker=require("../../../tokenizer/marker"),serializeProperty=require("../../../writer/one-time").property;module.exports=overrideProperties;