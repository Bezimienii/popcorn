function mergeIntoShorthands(e,n){var o,t,r,a,i,l,p,u={};if(!(e.length<3)){for(a=0,i=e.length;a<i;a++)if(r=e[a],o=compactable[r.name],!r.unused&&!r.hack&&!r.block&&(invalidateOrCompact(e,a,u,n),o&&o.componentOf))for(l=0,p=o.componentOf.length;l<p;l++)t=o.componentOf[l],u[t]=u[t]||{},u[t][r.name]=r;invalidateOrCompact(e,a,u,n)}}function invalidateOrCompact(e,n,o,t){var r,a,i,l=e[n];for(r in o)void 0!==l&&r==l.name||(a=compactable[r],i=o[r],l&&invalidates(o,r,l)?delete o[r]:a.components.length>Object.keys(i).length||mixedImportance(i)||overridable(i,r,t)&&mergeable(i)&&(mixedInherit(i)?replaceWithInheritBestFit(e,i,r,t):replaceWithShorthand(e,i,r,t)))}function invalidates(e,n,o){var t,r=compactable[n],a=compactable[o.name];if("overridesShorthands"in r&&r.overridesShorthands.indexOf(o.name)>-1)return!0;if(a&&"componentOf"in a)for(t in e[n])if(a.componentOf.indexOf(t)>-1)return!0;return!1}function mixedImportance(e){var n,o;for(o in e){if(void 0!==n&&e[o].important!=n)return!0;n=e[o].important}return!1}function overridable(e,n,o){var t,r,a,i,l=compactable[n],p=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,l.defaultValue]],u=wrapSingle(p);for(populateComponents([u],o,[]),a=0,i=l.components.length;a<i;a++)if(t=e[l.components[a]],r=compactable[t.name].canOverride,!everyValuesPair(r.bind(null,o),u.components[a],t))return!1;return!0}function mergeable(e){var n,o,t,r,a,i=null;for(o in e)if(t=e[o],r=compactable[o],"restore"in r){if(restoreFromOptimizing([t.all[t.position]],restoreWithComponents),a=r.restore(t,compactable),n=a.length,null!==i&&n!==i)return!1;i=n}return!0}function mixedInherit(e){var n,o,t=null;for(n in e){if(o=hasInherit(e[n]),null!==t&&t!==o)return!0;t=o}return!1}function replaceWithInheritBestFit(e,n,o,t){var r,a,i,l,p=buildSequenceWithInheritLonghands(n,o,t),u=buildSequenceWithInheritShorthand(n,o,t),s=p[0],h=u[0],m=serializeBody(s).length<serializeBody(h).length,c=m?s:h,d=m?p[1]:u[1],f=m?p[2]:u[2],v=n[Object.keys(n)[0]].all;d.position=v.length,d.shorthand=!0,d.dirty=!0,d.all=v,d.all.push(c[0]),e.push(d);for(r in n)a=n[r],a.unused=!0,a.name in f&&(i=f[a.name],l=findTokenIn(c,r),i.position=v.length,i.all=v,i.all.push(l),e.push(i))}function buildSequenceWithInheritLonghands(e,n,o){var t,r,a,i,l,p,u=[],s={},h={},m=compactable[n],c=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,m.defaultValue]],d=wrapSingle(c);for(populateComponents([d],o,[]),l=0,p=m.components.length;l<p;l++)t=e[m.components[l]],hasInherit(t)?(r=t.all[t.position].slice(0,2),Array.prototype.push.apply(r,t.value),u.push(r),a=deepClone(t),a.value=inferComponentValue(e,a.name),d.components[l]=a,s[t.name]=deepClone(t)):(a=deepClone(t),a.all=t.all,d.components[l]=a,h[t.name]=t);return i=joinMetadata(h,1),c[1].push(i),restoreFromOptimizing([d],restoreWithComponents),c=c.slice(0,2),Array.prototype.push.apply(c,d.value),u.unshift(c),[u,d,s]}function inferComponentValue(e,n){var o=compactable[n];return"oppositeTo"in o?e[o.oppositeTo].value:[[Token.PROPERTY_VALUE,o.defaultValue]]}function joinMetadata(e,n){var o,t,r,a,i=[];for(a in e)o=e[a],t=o.all[o.position],r=t[n][t[n].length-1],Array.prototype.push.apply(i,r);return i.sort(metadataSorter)}function metadataSorter(e,n){var o=e[0],t=n[0],r=e[1],a=n[1];return o<t?-1:o===t&&r<a?-1:1}function buildSequenceWithInheritShorthand(e,n,o){var t,r,a,i,l,p,u=[],s={},h={},m=compactable[n],c=[Token.PROPERTY,[Token.PROPERTY_NAME,n],[Token.PROPERTY_VALUE,"inherit"]],d=wrapSingle(c);for(populateComponents([d],o,[]),l=0,p=m.components.length;l<p;l++)t=e[m.components[l]],hasInherit(t)?s[t.name]=t:(r=t.all[t.position].slice(0,2),Array.prototype.push.apply(r,t.value),u.push(r),h[t.name]=deepClone(t));return a=joinMetadata(s,1),c[1].push(a),i=joinMetadata(s,2),c[2].push(i),u.unshift(c),[u,d,h]}function findTokenIn(e,n){var o,t;for(o=0,t=e.length;o<t;o++)if(e[o][1][1]==n)return e[o]}function replaceWithShorthand(e,n,o,t){var r,a,i,l=compactable[o],p=[Token.PROPERTY,[Token.PROPERTY_NAME,o],[Token.PROPERTY_VALUE,l.defaultValue]],u=wrapSingle(p);u.shorthand=!0,u.dirty=!0,populateComponents([u],t,[]);for(var s=0,h=l.components.length;s<h;s++){var m=n[l.components[s]];u.components[s]=deepClone(m),u.important=m.important,i=m.all}for(var c in n)n[c].unused=!0;r=joinMetadata(n,1),p[1].push(r),a=joinMetadata(n,2),p[2].push(a),u.position=i.length,u.all=i,u.all.push(p),e.push(u)}var everyValuesPair=require("./every-values-pair"),hasInherit=require("./has-inherit"),populateComponents=require("./populate-components"),compactable=require("../compactable"),deepClone=require("../clone").deep,restoreWithComponents=require("../restore-with-components"),restoreFromOptimizing=require("../../restore-from-optimizing"),wrapSingle=require("../../wrap-for-optimizing").single,serializeBody=require("../../../writer/one-time").body,Token=require("../../../tokenizer/token");module.exports=mergeIntoShorthands;