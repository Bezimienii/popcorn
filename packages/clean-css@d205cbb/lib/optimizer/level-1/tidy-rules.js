function hasInvalidCharacters(e){var r,E,T,_,a=!1,s=!1;for(T=0,_=e.length;T<_;T++){if(E=e[T],r);else if(E==Marker.SINGLE_QUOTE||E==Marker.DOUBLE_QUOTE)s=!s;else{if(!(s||E!=Marker.CLOSE_CURLY_BRACKET&&E!=Marker.EXCLAMATION&&E!=LESS_THAN&&E!=Marker.SEMICOLON)){a=!0;break}if(!s&&0===T&&RELATION_PATTERN.test(E)){a=!0;break}}r=E==Marker.BACK_SLASH}return a}function removeWhitespace(e,r){var E,T,_,a,s,A,i,t,S,n,o,p,N,R=[],l=0,O=!1,u=!1,L=CASE_ATTRIBUTE_PATTERN.test(e),f=r&&r.spaces[Spaces.AroundSelectorRelation];for(p=0,N=e.length;p<N;p++){if(E=e[p],T=E==Marker.NEW_LINE_NIX,_=E==Marker.NEW_LINE_NIX&&e[p-1]==Marker.NEW_LINE_WIN,A=i||t,n=!S&&!a&&0===l&&RELATION_PATTERN.test(E),o=WHITESPACE_PATTERN.test(E),s&&A&&_)R.pop(),R.pop();else if(a&&A&&T)R.pop();else if(a)R.push(E);else if(E!=Marker.OPEN_SQUARE_BRACKET||A)if(E!=Marker.CLOSE_SQUARE_BRACKET||A)if(E!=Marker.OPEN_ROUND_BRACKET||A)if(E!=Marker.CLOSE_ROUND_BRACKET||A)if(E!=Marker.SINGLE_QUOTE||A)if(E!=Marker.DOUBLE_QUOTE||A)if(E==Marker.SINGLE_QUOTE&&A)R.push(E),i=!1;else if(E==Marker.DOUBLE_QUOTE&&A)R.push(E),t=!1;else{if(o&&O&&!f)continue;!o&&O&&f?(R.push(Marker.SPACE),R.push(E)):o&&(S||l>0)&&!A||o&&u&&!A||(_||T)&&(S||l>0)&&A||(n&&u&&!f?(R.pop(),R.push(E)):n&&!u&&f?(R.push(Marker.SPACE),R.push(E)):o?R.push(Marker.SPACE):R.push(E))}else R.push(E),t=!0;else R.push(E),i=!0;else R.push(E),l--;else R.push(E),l++;else R.push(E),S=!1;else R.push(E),S=!0;s=a,a=E==Marker.BACK_SLASH,O=n,u=o}return L?R.join("").replace(CASE_RESTORE_PATTERN,"$1 $2]"):R.join("")}function removeQuotes(e){return e.indexOf("'")==-1&&e.indexOf('"')==-1?e:e.replace(SINGLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(SINGLE_QUOTE_PATTERN,"=$1$2").replace(DOUBLE_QUOTE_CASE_PATTERN,"=$1 $2").replace(DOUBLE_QUOTE_PATTERN,"=$1$2")}function tidyRules(e,r,E,T,_){function a(e,r){return _.push("HTML comment '"+r+"' at "+formatPosition(e[2][0])+". Removing."),""}for(var s=[],A=[],i=0,t=e.length;i<t;i++){var S=e[i],n=S[1];n=n.replace(HTML_COMMENT_PATTERN,a.bind(null,S)),hasInvalidCharacters(n)?_.push("Invalid selector '"+S[1]+"' at "+formatPosition(S[2][0])+". Ignoring."):(n=removeWhitespace(n,T),n=removeQuotes(n),E&&n.indexOf("nav")>0&&(n=n.replace(/\+nav(\S|$)/,"+ nav$1")),r&&n.indexOf(ASTERISK_PLUS_HTML_HACK)>-1||r&&n.indexOf(ASTERISK_FIRST_CHILD_PLUS_HTML_HACK)>-1||(n.indexOf("*")>-1&&(n=n.replace(/\*([:#\.\[])/g,"$1").replace(/^(\:first\-child)?\+html/,"*$1+html")),A.indexOf(n)>-1||(S[1]=n,A.push(n),s.push(S))))}return 1==s.length&&0===s[0][1].length&&(_.push("Empty selector '"+s[0][1]+"' at "+formatPosition(s[0][2][0])+". Ignoring."),s=[]),s}var Spaces=require("../../options/format").Spaces,Marker=require("../../tokenizer/marker"),formatPosition=require("../../utils/format-position"),CASE_ATTRIBUTE_PATTERN=/[\s"'][iI]\s*\]/,CASE_RESTORE_PATTERN=/([\d\w])([iI])\]/g,DOUBLE_QUOTE_CASE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"([iI])/g,DOUBLE_QUOTE_PATTERN=/="([a-zA-Z][a-zA-Z\d\-_]+)"(\s|\])/g,HTML_COMMENT_PATTERN=/^(?:(?:<!--|-->)\s*)+/,SINGLE_QUOTE_CASE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'([iI])/g,SINGLE_QUOTE_PATTERN=/='([a-zA-Z][a-zA-Z\d\-_]+)'(\s|\])/g,RELATION_PATTERN=/[>\+~]/,WHITESPACE_PATTERN=/\s/,ASTERISK_PLUS_HTML_HACK="*+html ",ASTERISK_FIRST_CHILD_PLUS_HTML_HACK="*:first-child+html ",LESS_THAN="<";module.exports=tidyRules;