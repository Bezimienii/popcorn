function isNegative(e){return e&&"-"==e[1][0]&&parseFloat(e[1])<0}function isQuoted(e){return QUOTED_PATTERN.test(e)}function isUrl(e){return URL_PREFIX_PATTERN.test(e)}function normalizeUrl(e){return e.replace(URL_PREFIX_PATTERN,"url(").replace(/\\?\n|\\?\r\n/g,"")}function optimizeBackground(e){var i=e.value;1==i.length&&"none"==i[0][1]&&(i[0][1]="0 0"),1==i.length&&"transparent"==i[0][1]&&(i[0][1]="0 0")}function optimizeBorderRadius(e){var i,t=e.value;3==t.length&&"/"==t[1][1]&&t[0][1]==t[2][1]?i=1:5==t.length&&"/"==t[2][1]&&t[0][1]==t[3][1]&&t[1][1]==t[4][1]?i=2:7==t.length&&"/"==t[3][1]&&t[0][1]==t[4][1]&&t[1][1]==t[5][1]&&t[2][1]==t[6][1]?i=3:9==t.length&&"/"==t[4][1]&&t[0][1]==t[5][1]&&t[1][1]==t[6][1]&&t[2][1]==t[7][1]&&t[3][1]==t[8][1]&&(i=4),i&&(e.value.splice(i),e.dirty=!0)}function optimizeColors(e,i,t){return i.indexOf("#")===-1&&i.indexOf("rgb")==-1&&i.indexOf("hsl")==-1?shortenHex(i):(i=i.replace(/rgb\((\-?\d+),(\-?\d+),(\-?\d+)\)/g,function(e,i,t,r){return shortenRgb(i,t,r)}).replace(/hsl\((-?\d+),(-?\d+)%?,(-?\d+)%?\)/g,function(e,i,t,r){return shortenHsl(i,t,r)}).replace(/(^|[^='"])#([0-9a-f]{6})/gi,function(e,i,t,r,n){var o=n[r+e.length];return o&&HEX_VALUE_PATTERN.test(o)?e:t[0]==t[1]&&t[2]==t[3]&&t[4]==t[5]?(i+"#"+t[0]+t[2]+t[4]).toLowerCase():(i+"#"+t).toLowerCase()}).replace(/(^|[^='"])#([0-9a-f]{3})/gi,function(e,i,t){return i+"#"+t.toLowerCase()}).replace(/(rgb|rgba|hsl|hsla)\(([^\)]+)\)/g,function(e,i,t){var r=t.split(","),n="hsl"==i&&3==r.length||"hsla"==i&&4==r.length||"rgb"==i&&3==r.length&&t.indexOf("%")>0||"rgba"==i&&4==r.length&&t.indexOf("%")>0;return n?(r[1].indexOf("%")==-1&&(r[1]+="%"),r[2].indexOf("%")==-1&&(r[2]+="%"),i+"("+r.join(",")+")"):e}),t.colors.opacity&&e.indexOf("background")==-1&&(i=i.replace(/(?:rgba|hsla)\(0,0%?,0%?,0\)/g,function(e){return split(i,",").pop().indexOf("gradient(")>-1?e:"transparent"})),shortenHex(i))}function optimizeFilter(e){1==e.value.length&&(e.value[0][1]=e.value[0][1].replace(/progid:DXImageTransform\.Microsoft\.(Alpha|Chroma)(\W)/,function(e,i,t){return i.toLowerCase()+t})),e.value[0][1]=e.value[0][1].replace(/,(\S)/g,", $1").replace(/ ?= ?/g,"=")}function optimizeFontWeight(e,i){var t=e.value[i][1];"normal"==t?t="400":"bold"==t&&(t="700"),e.value[i][1]=t}function optimizeMultipleZeros(e){var i,t=e.value;4==t.length&&"0"===t[0][1]&&"0"===t[1][1]&&"0"===t[2][1]&&"0"===t[3][1]&&(i=e.name.indexOf("box-shadow")>-1?2:1),i&&(e.value.splice(i),e.dirty=!0)}function optimizeOutline(e){var i=e.value;1==i.length&&"none"==i[0][1]&&(i[0][1]="0")}function optimizePixelLengths(e,i,t){return WHOLE_PIXEL_VALUE.test(i)?i.replace(WHOLE_PIXEL_VALUE,function(e,i){var r,n=parseInt(i);return 0===n?e:(t.properties.shorterLengthUnits&&t.units.pt&&3*n%4===0&&(r=3*n/4+"pt"),t.properties.shorterLengthUnits&&t.units.pc&&n%16===0&&(r=n/16+"pc"),t.properties.shorterLengthUnits&&t.units["in"]&&n%96===0&&(r=n/96+"in"),r&&(r=e.substring(0,e.indexOf(i))+r),r&&r.length<e.length?r:e)}):i}function optimizePrecision(e,i,t){return t.enabled&&i.indexOf(".")!==-1?i.replace(t.decimalPointMatcher,"$1$2$3").replace(t.zeroMatcher,function(e,i,r,n){var o=t.units[n].multiplier,a=parseInt(i),s=isNaN(a)?0:a,l=parseFloat(r);return Math.round((s+l)*o)/o+n}):i}function optimizeTimeUnits(e,i){return TIME_VALUE.test(i)?i.replace(TIME_VALUE,function(e,i,t){var r;return"ms"==t?r=parseInt(i)/1e3+"s":"s"==t&&(r=1e3*parseFloat(i)+"ms"),r.length<e.length?r:e}):i}function optimizeUnits(e,i,t){return/^(?:\-moz\-calc|\-webkit\-calc|calc|rgb|hsl|rgba|hsla)\(/.test(i)?i:"flex"==e||"-ms-flex"==e||"-webkit-flex"==e||"flex-basis"==e||"-webkit-flex-basis"==e?i:i.indexOf("%")>0&&("height"==e||"max-height"==e||"width"==e||"max-width"==e)?i:i.replace(t,"$10$2").replace(t,"$10$2")}function optimizeWhitespace(e,i){return e.indexOf("filter")>-1||i.indexOf(" ")==-1||0===i.indexOf("expression")?i:i.indexOf(Marker.SINGLE_QUOTE)>-1||i.indexOf(Marker.DOUBLE_QUOTE)>-1?i:(i=i.replace(/\s+/g," "),i.indexOf("calc")>-1&&(i=i.replace(/\) ?\/ ?/g,")/ ")),i.replace(/(\(;?)\s+/g,"$1").replace(/\s+(;?\))/g,"$1").replace(/, /g,","))}function optimizeZeroDegUnit(e,i){return i.indexOf("0deg")==-1?i:i.replace(/\(0deg\)/g,"(0)")}function optimizeZeroUnits(e,i){return i.indexOf("0")==-1?i:(i.indexOf("-")>-1&&(i=i.replace(/([^\w\d\-]|^)\-0([^\.]|$)/g,"$10$2").replace(/([^\w\d\-]|^)\-0([^\.]|$)/g,"$10$2")),i.replace(/(^|\s)0+([1-9])/g,"$1$2").replace(/(^|\D)\.0+(\D|$)/g,"$10$2").replace(/(^|\D)\.0+(\D|$)/g,"$10$2").replace(/\.([1-9]*)0+(\D|$)/g,function(e,i,t){return(i.length>0?".":"")+i+t}).replace(/(^|\D)0\.(\d)/g,"$1.$2"))}function removeQuotes(e,i){return"content"==e||e.indexOf("font-feature-settings")>-1||e.indexOf("grid-")>-1?i:QUOTED_BUT_SAFE_PATTERN.test(i)?i.substring(1,i.length-1):i}function removeUrlQuotes(e){return!/^url\(['"].+['"]\)$/.test(e)||/^url\(['"].*[\*\s\(\)'"].*['"]\)$/.test(e)||/^url\(['"]data:[^;]+;charset/.test(e)?e:e.replace(/["']/g,"")}function transformValue(e,i,t){var r=t(e,i);return void 0===r?i:r===!1?IgnoreProperty:r}function optimizeBody(e,i){var t,r,n,o,a,s,l=i.options,p=l.level[OptimizationLevel.One],u=wrapForOptimizing(e,!0);e:for(var c=0,m=u.length;c<m;c++)if(t=u[c],r=t.name,PROPERTY_NAME_PATTERN.test(r)||(s=t.all[t.position],i.warnings.push("Invalid property name '"+r+"' at "+formatPosition(s[1][2][0])+". Ignoring."),t.unused=!0),0===t.value.length&&(s=t.all[t.position],i.warnings.push("Empty property '"+r+"' at "+formatPosition(s[1][2][0])+". Ignoring."),t.unused=!0),t.hack&&((t.hack[0]==Hack.ASTERISK||t.hack[0]==Hack.UNDERSCORE)&&!l.compatibility.properties.iePrefixHack||t.hack[0]==Hack.BACKSLASH&&!l.compatibility.properties.ieSuffixHack||t.hack[0]==Hack.BANG&&!l.compatibility.properties.ieBangHack)&&(t.unused=!0),p.removeNegativePaddings&&0===r.indexOf("padding")&&(isNegative(t.value[0])||isNegative(t.value[1])||isNegative(t.value[2])||isNegative(t.value[3]))&&(t.unused=!0),!l.compatibility.properties.ieFilters&&isLegacyFilter(t)&&(t.unused=!0),!t.unused)if(t.block)optimizeBody(t.value[0][1],i);else if(!VARIABLE_NAME_PATTERN.test(r)){for(var g=0,d=t.value.length;g<d;g++){if(n=t.value[g][0],o=t.value[g][1],a=isUrl(o),n==Token.PROPERTY_BLOCK){t.unused=!0,i.warnings.push("Invalid value token at "+formatPosition(o[0][1][2][0])+". Ignoring.");break}if(a&&!i.validator.isUrl(o)){t.unused=!0,i.warnings.push("Broken URL '"+o+"' at "+formatPosition(t.value[g][2][0])+". Ignoring.");break}if(a?(o=p.normalizeUrls?normalizeUrl(o):o,o=l.compatibility.properties.urlQuotes?o:removeUrlQuotes(o)):isQuoted(o)?o=p.removeQuotes?removeQuotes(r,o):o:(o=p.removeWhitespace?optimizeWhitespace(r,o):o,o=optimizePrecision(r,o,l.precision),o=optimizePixelLengths(r,o,l.compatibility),o=p.replaceTimeUnits?optimizeTimeUnits(r,o):o,o=p.replaceZeroUnits?optimizeZeroUnits(r,o):o,l.compatibility.properties.zeroUnits&&(o=optimizeZeroDegUnit(r,o),o=optimizeUnits(r,o,l.unitsRegexp)),l.compatibility.properties.colors&&(o=optimizeColors(r,o,l.compatibility))),o=transformValue(r,o,p.transform),o===IgnoreProperty){t.unused=!0;continue e}t.value[g][1]=o}p.replaceMultipleZeros&&optimizeMultipleZeros(t),"background"==r&&p.optimizeBackground?optimizeBackground(t):0===r.indexOf("border")&&r.indexOf("radius")>0&&p.optimizeBorderRadius?optimizeBorderRadius(t):"filter"==r&&p.optimizeFilter&&l.compatibility.properties.ieFilters?optimizeFilter(t):"font-weight"==r&&p.optimizeFontWeight?optimizeFontWeight(t,0):"outline"==r&&p.optimizeOutline&&optimizeOutline(t)}restoreFromOptimizing(u),removeUnused(u),removeComments(e,l)}function removeComments(e,i){var t,r;for(r=0;r<e.length;r++)t=e[r],t[0]==Token.COMMENT&&(optimizeComment(t,i),0===t[1].length&&(e.splice(r,1),r--))}function optimizeComment(e,i){return e[1][2]==Marker.EXCLAMATION&&("all"==i.level[OptimizationLevel.One].specialComments||i.commentsKept<i.level[OptimizationLevel.One].specialComments)?void i.commentsKept++:void(e[1]=[])}function cleanupCharsets(e){for(var i=!1,t=0,r=e.length;t<r;t++){var n=e[t];n[0]==Token.AT_RULE&&CHARSET_REGEXP.test(n[1])&&(i||n[1].indexOf(CHARSET_TOKEN)==-1?(e.splice(t,1),t--,r--):(i=!0,e.splice(t,1),e.unshift([Token.AT_RULE,n[1].replace(CHARSET_REGEXP,CHARSET_TOKEN)])))}}function buildUnitRegexp(e){var i=["px","em","ex","cm","mm","in","pt","pc","%"],t=["ch","rem","vh","vm","vmax","vmin","vw"];return t.forEach(function(t){e.compatibility.units[t]&&i.push(t)}),new RegExp("(^|\\s|\\(|,)0(?:"+i.join("|")+")(\\W|$)","g")}function buildPrecisionOptions(e){var i,t,r={matcher:null,units:{}},n=[];for(i in e)t=e[i],t!=DEFAULT_ROUNDING_PRECISION&&(r.units[i]={},r.units[i].value=t,r.units[i].multiplier=Math.pow(10,t),n.push(i));return n.length>0&&(r.enabled=!0,r.decimalPointMatcher=new RegExp("(\\d)\\.($|"+n.join("|")+")($|W)","g"),r.zeroMatcher=new RegExp("(\\d*)(\\.\\d+)("+n.join("|")+")","g")),r}function isImport(e){return IMPORT_PREFIX_PATTERN.test(e[1])}function isLegacyFilter(e){var i;return("filter"==e.name||"-ms-filter"==e.name)&&(i=e.value[0][1],i.indexOf("progid")>-1||0===i.indexOf("alpha")||0===i.indexOf("chroma"))}function level1Optimize(e,i){var t=i.options,r=t.level[OptimizationLevel.One],n=t.compatibility.selectors.ie7Hack,o=t.compatibility.selectors.adjacentSpace,a=t.compatibility.properties.spaceAfterClosingBrace,s=t.format,l=!1,p=!1;t.unitsRegexp=t.unitsRegexp||buildUnitRegexp(t),t.precision=t.precision||buildPrecisionOptions(r.roundingPrecision),t.commentsKept=t.commentsKept||0;for(var u=0,c=e.length;u<c;u++){var m=e[u];switch(m[0]){case Token.AT_RULE:m[1]=isImport(m)&&p?"":m[1],m[1]=r.tidyAtRules?tidyAtRule(m[1]):m[1],l=!0;break;case Token.AT_RULE_BLOCK:optimizeBody(m[2],i),p=!0;break;case Token.NESTED_BLOCK:m[1]=r.tidyBlockScopes?tidyBlock(m[1],a):m[1],level1Optimize(m[2],i),p=!0;break;case Token.COMMENT:optimizeComment(m,t);break;case Token.RULE:m[1]=r.tidySelectors?tidyRules(m[1],!n,o,s,i.warnings):m[1],m[1]=m[1].length>1?sortSelectors(m[1],r.selectorsSortingMethod):m[1],optimizeBody(m[2],i),p=!0}(m[0]==Token.COMMENT&&0===m[1].length||r.removeEmpty&&(0===m[1].length||m[2]&&0===m[2].length))&&(e.splice(u,1),u--,c--)}return r.cleanupCharsets&&l&&cleanupCharsets(e),e}var shortenHex=require("./shorten-hex"),shortenHsl=require("./shorten-hsl"),shortenRgb=require("./shorten-rgb"),sortSelectors=require("./sort-selectors"),tidyRules=require("./tidy-rules"),tidyBlock=require("./tidy-block"),tidyAtRule=require("./tidy-at-rule"),Hack=require("../hack"),removeUnused=require("../remove-unused"),restoreFromOptimizing=require("../restore-from-optimizing"),wrapForOptimizing=require("../wrap-for-optimizing").all,OptimizationLevel=require("../../options/optimization-level").OptimizationLevel,Token=require("../../tokenizer/token"),Marker=require("../../tokenizer/marker"),formatPosition=require("../../utils/format-position"),split=require("../../utils/split"),IgnoreProperty="ignore-property",CHARSET_TOKEN="@charset",CHARSET_REGEXP=new RegExp("^"+CHARSET_TOKEN,"i"),DEFAULT_ROUNDING_PRECISION=require("../../options/rounding-precision").DEFAULT,WHOLE_PIXEL_VALUE=/(?:^|\s|\()(-?\d+)px/,TIME_VALUE=/^(\-?[\d\.]+)(m?s)$/,HEX_VALUE_PATTERN=/[0-9a-f]/i,PROPERTY_NAME_PATTERN=/^(?:\-chrome\-|\-[\w\-]+\w|\w[\w\-]+\w|\-\-\S+)$/,IMPORT_PREFIX_PATTERN=/^@import/i,QUOTED_PATTERN=/^('.*'|".*")$/,QUOTED_BUT_SAFE_PATTERN=/^['"][a-zA-Z][a-zA-Z\d\-_]+['"]$/,URL_PREFIX_PATTERN=/^url\(/i,VARIABLE_NAME_PATTERN=/^--\S+$/;module.exports=level1Optimize;