function tokenize(e,r){var n={level:Level.BLOCK,position:{source:r.source||void 0,line:1,column:0,index:0}};return intoTokens(e,r,n,!1)}function intoTokens(e,r,n,o){for(var i,l,E,t,L,a,T,R,s,O,_,p,u,k=[],M=k,C=[],U=[],h=n.level,A=[],S=[],g=[],m=0,f=!1,v=!1,P=!1,N=!1,B=!1,c=n.position;c.index<e.length;c.index++){var K=e[c.index];if(a=h==Level.SINGLE_QUOTE||h==Level.DOUBLE_QUOTE,T=K==Marker.SPACE||K==Marker.TAB,R=K==Marker.NEW_LINE_NIX,s=K==Marker.NEW_LINE_NIX&&e[c.index-1]==Marker.NEW_LINE_WIN,O=!v&&h!=Level.COMMENT&&!a&&K==Marker.ASTERISK&&e[c.index-1]==Marker.FORWARD_SLASH,p=!f&&!a&&K==Marker.FORWARD_SLASH&&e[c.index-1]==Marker.ASTERISK,_=h==Level.COMMENT&&p,t=0===S.length?[c.line,c.column,c.source]:t,u)S.push(K);else if(_||h!=Level.COMMENT)if(O&&(h==Level.BLOCK||h==Level.RULE)&&S.length>1)U.push(t),S.push(K),g.push(S.slice(0,S.length-2)),S=S.slice(S.length-2),t=[c.line,c.column-1,c.source],A.push(h),h=Level.COMMENT;else if(O)A.push(h),h=Level.COMMENT,S.push(K);else if(_)L=S.join("").trim()+K,i=[Token.COMMENT,L,[originalMetadata(t,L,r)]],M.push(i),h=A.pop(),t=U.pop()||null,S=g.pop()||[];else if(p&&e[c.index+1]!=Marker.ASTERISK)r.warnings.push("Unexpected '*/' at "+formatPosition([c.line,c.column,c.source])+"."),S=[];else if(K!=Marker.SINGLE_QUOTE||a)if(K==Marker.SINGLE_QUOTE&&h==Level.SINGLE_QUOTE)h=A.pop(),S.push(K);else if(K!=Marker.DOUBLE_QUOTE||a)if(K==Marker.DOUBLE_QUOTE&&h==Level.DOUBLE_QUOTE)h=A.pop(),S.push(K);else if(!O&&!_&&K!=Marker.CLOSE_ROUND_BRACKET&&K!=Marker.OPEN_ROUND_BRACKET&&h!=Level.COMMENT&&!a&&m>0)S.push(K);else if(K!=Marker.OPEN_ROUND_BRACKET||a||h==Level.COMMENT||N)if(K!=Marker.CLOSE_ROUND_BRACKET||a||h==Level.COMMENT||N)if(K==Marker.SEMICOLON&&h==Level.BLOCK&&S[0]==Marker.AT)L=S.join("").trim(),k.push([Token.AT_RULE,L,[originalMetadata(t,L,r)]]),S=[];else if(K==Marker.COMMA&&h==Level.BLOCK&&l)L=S.join("").trim(),l[1].push([tokenScopeFrom(l[0]),L,[originalMetadata(t,L,r,l[1].length)]]),S=[];else if(K==Marker.COMMA&&h==Level.BLOCK&&tokenTypeFrom(S)==Token.AT_RULE)S.push(K);else if(K==Marker.COMMA&&h==Level.BLOCK)l=[tokenTypeFrom(S),[],[]],L=S.join("").trim(),l[1].push([tokenScopeFrom(l[0]),L,[originalMetadata(t,L,r,0)]]),S=[];else if(K==Marker.OPEN_CURLY_BRACKET&&h==Level.BLOCK&&l&&l[0]==Token.NESTED_BLOCK)L=S.join("").trim(),l[1].push([Token.NESTED_BLOCK_SCOPE,L,[originalMetadata(t,L,r)]]),k.push(l),A.push(h),c.column++,c.index++,S=[],l[2]=intoTokens(e,r,n,!0),l=null;else if(K==Marker.OPEN_CURLY_BRACKET&&h==Level.BLOCK&&tokenTypeFrom(S)==Token.NESTED_BLOCK)L=S.join("").trim(),l=l||[Token.NESTED_BLOCK,[],[]],l[1].push([Token.NESTED_BLOCK_SCOPE,L,[originalMetadata(t,L,r)]]),k.push(l),A.push(h),c.column++,c.index++,S=[],l[2]=intoTokens(e,r,n,!0),l=null;else if(K==Marker.OPEN_CURLY_BRACKET&&h==Level.BLOCK)L=S.join("").trim(),l=l||[tokenTypeFrom(S),[],[]],l[1].push([tokenScopeFrom(l[0]),L,[originalMetadata(t,L,r,l[1].length)]]),M=l[2],k.push(l),A.push(h),h=Level.RULE,S=[];else if(K==Marker.OPEN_CURLY_BRACKET&&h==Level.RULE&&N)C.push(l),l=[Token.PROPERTY_BLOCK,[]],E.push(l),M=l[1],A.push(h),h=Level.RULE,N=!1;else if(K==Marker.OPEN_CURLY_BRACKET&&h==Level.RULE&&isPageMarginBox(S))L=S.join("").trim(),C.push(l),l=[Token.AT_RULE_BLOCK,[],[]],l[1].push([Token.AT_RULE_BLOCK_SCOPE,L,[originalMetadata(t,L,r)]]),M.push(l),M=l[2],A.push(h),h=Level.RULE,S=[];else if(K!=Marker.COLON||h!=Level.RULE||N)if(K==Marker.SEMICOLON&&h==Level.RULE&&E&&C.length>0&&S.length>0&&S[0]==Marker.AT)L=S.join("").trim(),l[1].push([Token.AT_RULE,L,[originalMetadata(t,L,r)]]),S=[];else if(K==Marker.SEMICOLON&&h==Level.RULE&&E&&S.length>0)L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),E=null,N=!1,S=[];else if(K==Marker.SEMICOLON&&h==Level.RULE&&E&&0===S.length)E=null,N=!1;else if(K==Marker.SEMICOLON&&h==Level.RULE&&S.length>0&&S[0]==Marker.AT)L=S.join(""),M.push([Token.AT_RULE,L,[originalMetadata(t,L,r)]]),N=!1,S=[];else if(K==Marker.SEMICOLON&&h==Level.RULE&&B)B=!1,S=[];else if(K==Marker.SEMICOLON&&h==Level.RULE&&0===S.length);else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&E&&N&&S.length>0&&C.length>0)L=S.join(""),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),E=null,l=C.pop(),M=l[2],h=A.pop(),N=!1,S=[];else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&E&&S.length>0&&S[0]==Marker.AT&&C.length>0)L=S.join(""),l[1].push([Token.AT_RULE,L,[originalMetadata(t,L,r)]]),E=null,l=C.pop(),M=l[2],h=A.pop(),N=!1,S=[];else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&E&&C.length>0)E=null,l=C.pop(),M=l[2],h=A.pop(),N=!1;else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&E&&S.length>0)L=S.join(""),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),E=null,l=C.pop(),M=k,h=A.pop(),N=!1,S=[];else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&S.length>0&&S[0]==Marker.AT)E=null,l=null,L=S.join("").trim(),M.push([Token.AT_RULE,L,[originalMetadata(t,L,r)]]),M=k,h=A.pop(),N=!1,S=[];else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE&&A[A.length-1]==Level.RULE)E=null,l=C.pop(),M=l[2],h=A.pop(),N=!1,B=!0,S=[];else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.RULE)E=null,l=null,M=k,h=A.pop(),N=!1;else if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.BLOCK&&!o&&c.index<=e.length-1)r.warnings.push("Unexpected '}' at "+formatPosition([c.line,c.column,c.source])+"."),S.push(K);else{if(K==Marker.CLOSE_CURLY_BRACKET&&h==Level.BLOCK)break;K==Marker.OPEN_ROUND_BRACKET&&h==Level.RULE&&N?(S.push(K),m++):K==Marker.CLOSE_ROUND_BRACKET&&h==Level.RULE&&N&&1==m?(S.push(K),L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),m--,S=[]):K==Marker.CLOSE_ROUND_BRACKET&&h==Level.RULE&&N?(S.push(K),m--):K==Marker.FORWARD_SLASH&&e[c.index+1]!=Marker.ASTERISK&&h==Level.RULE&&N&&S.length>0?(L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),E.push([Token.PROPERTY_VALUE,K,[[c.line,c.column,c.source]]]),S=[]):K==Marker.FORWARD_SLASH&&e[c.index+1]!=Marker.ASTERISK&&h==Level.RULE&&N?(E.push([Token.PROPERTY_VALUE,K,[[c.line,c.column,c.source]]]),S=[]):K==Marker.COMMA&&h==Level.RULE&&N&&S.length>0?(L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),E.push([Token.PROPERTY_VALUE,K,[[c.line,c.column,c.source]]]),S=[]):K==Marker.COMMA&&h==Level.RULE&&N?(E.push([Token.PROPERTY_VALUE,K,[[c.line,c.column,c.source]]]),S=[]):K==Marker.CLOSE_SQUARE_BRACKET&&E&&E.length>1&&S.length>0&&isRepeatToken(S)?(S.push(K),L=S.join("").trim(),E[E.length-1][1]+=L,S=[]):(T||R&&!s)&&h==Level.RULE&&N&&E&&S.length>0?(L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),S=[]):s&&h==Level.RULE&&N&&E&&S.length>1?(L=S.join("").trim(),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),S=[]):s&&h==Level.RULE&&N?S=[]:1==S.length&&s?S.pop():(S.length>0||!T&&!R&&!s)&&S.push(K)}else L=S.join("").trim(),E=[Token.PROPERTY,[Token.PROPERTY_NAME,L,[originalMetadata(t,L,r)]]],M.push(E),N=!0,S=[];else S.push(K),m--;else S.push(K),m++;else A.push(h),h=Level.DOUBLE_QUOTE,S.push(K);else A.push(h),h=Level.SINGLE_QUOTE,S.push(K);else S.push(K);P=u,u=!P&&K==Marker.BACK_SLASH,f=O,v=_,c.line=s||R?c.line+1:c.line,c.column=s||R?0:c.column+1}return N&&r.warnings.push("Missing '}' at "+formatPosition([c.line,c.column,c.source])+"."),N&&S.length>0&&(L=S.join("").replace(TAIL_BROKEN_VALUE_PATTERN,""),E.push([Token.PROPERTY_VALUE,L,[originalMetadata(t,L,r)]]),S=[]),S.length>0&&r.warnings.push("Invalid character(s) '"+S.join("")+"' at "+formatPosition(t)+". Ignoring."),k}function originalMetadata(e,r,n,o){var i=e[2];return n.inputSourceMapTracker.isTracking(i)?n.inputSourceMapTracker.originalPositionFor(e,r.length,o):e}function tokenTypeFrom(e){var r=e[0]==Marker.AT||e[0]==Marker.UNDERSCORE,n=e.join("").split(RULE_WORD_SEPARATOR_PATTERN)[0];return r&&BLOCK_RULES.indexOf(n)>-1?Token.NESTED_BLOCK:r&&AT_RULES.indexOf(n)>-1?Token.AT_RULE:r?Token.AT_RULE_BLOCK:Token.RULE}function tokenScopeFrom(e){return e==Token.RULE?Token.RULE_SCOPE:e==Token.NESTED_BLOCK?Token.NESTED_BLOCK_SCOPE:e==Token.AT_RULE_BLOCK?Token.AT_RULE_BLOCK_SCOPE:void 0}function isPageMarginBox(e){var r=e.join("").trim();return PAGE_MARGIN_BOXES.indexOf(r)>-1||EXTRA_PAGE_BOXES.indexOf(r)>-1}function isRepeatToken(e){return REPEAT_PATTERN.test(e.join("")+Marker.CLOSE_SQUARE_BRACKET)}var Marker=require("./marker"),Token=require("./token"),formatPosition=require("../utils/format-position"),Level={BLOCK:"block",COMMENT:"comment",DOUBLE_QUOTE:"double-quote",RULE:"rule",SINGLE_QUOTE:"single-quote"},AT_RULES=["@charset","@import"],BLOCK_RULES=["@-moz-document","@document","@-moz-keyframes","@-ms-keyframes","@-o-keyframes","@-webkit-keyframes","@keyframes","@media","@supports"],PAGE_MARGIN_BOXES=["@bottom-center","@bottom-left","@bottom-left-corner","@bottom-right","@bottom-right-corner","@left-bottom","@left-middle","@left-top","@right-bottom","@right-middle","@right-top","@top-center","@top-left","@top-left-corner","@top-right","@top-right-corner"],EXTRA_PAGE_BOXES=["@footnote","@footnotes","@left","@page-float-bottom","@page-float-top","@right"],REPEAT_PATTERN=/^\[\s*\d+\s*\]$/,RULE_WORD_SEPARATOR_PATTERN=/[\s\(]/,TAIL_BROKEN_VALUE_PATTERN=/[\s|\}]*$/;module.exports=tokenize;