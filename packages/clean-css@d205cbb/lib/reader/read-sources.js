function readSources(e,o,n){return doReadSources(e,o,function(e){return applySourceMaps(e,o,function(){return loadOriginalSources(o,function(){return n(e)})})})}function doReadSources(e,o,n){return"string"==typeof e?fromString(e,o,n):Buffer.isBuffer(e)?fromString(e.toString(),o,n):Array.isArray(e)?fromArray(e,o,n):"object"==typeof e?fromHash(e,o,n):void 0}function fromString(e,o,n){return o.source=void 0,o.sourcesContent[void 0]=e,o.stats.originalSize+=e.length,fromStyles(e,o,{inline:o.options.inline},n)}function fromArray(e,o,n){var r=e.reduce(function(e,n){return"string"==typeof n?addStringSource(n,e):addHashSource(n,o,e)},[]);return fromStyles(r.join(""),o,{inline:["all"]},n)}function fromHash(e,o,n){var r=addHashSource(e,o,[]);return fromStyles(r.join(""),o,{inline:["all"]},n)}function addStringSource(e,o){return o.push(restoreAsImport(normalizeUri(e))),o}function addHashSource(e,o,n){var r,t,s;for(r in e)s=e[r],t=normalizeUri(r),n.push(restoreAsImport(t)),o.sourcesContent[t]=s.styles,s.sourceMap&&trackSourceMap(s.sourceMap,t,o);return n}function normalizeUri(e){var o,n,r,t=path.resolve("");return isRemoteResource(e)?e:(o=path.isAbsolute(e)?e:path.resolve(e),n=path.relative(t,o),r=normalizePath(n))}function trackSourceMap(e,o,n){var r="string"==typeof e?JSON.parse(e):e,t=isRemoteResource(o)?rebaseRemoteMap(r,o):rebaseLocalMap(r,o||UNKNOWN_URI,n.options.rebaseTo);n.inputSourceMapTracker.track(o,t)}function restoreAsImport(e){return restoreImport("url("+e+")","")+Marker.SEMICOLON}function fromStyles(e,o,n,r){var t,s={};return o.source?isRemoteResource(o.source)?(s.fromBase=o.source,s.toBase=o.source):path.isAbsolute(o.source)?(s.fromBase=path.dirname(o.source),s.toBase=o.options.rebaseTo):(s.fromBase=path.dirname(path.resolve(o.source)),s.toBase=o.options.rebaseTo):(s.fromBase=path.resolve(""),s.toBase=o.options.rebaseTo),t=tokenize(e,o),t=rebase(t,o.options.rebase,o.validator,s),allowsAnyImports(n.inline)?inline(t,o,n,r):r(t)}function allowsAnyImports(e){return!(1==e.length&&"none"==e[0])}function inline(e,o,n,r){var t={afterContent:!1,callback:r,errors:o.errors,externalContext:o,fetch:o.options.fetch,inlinedStylesheets:n.inlinedStylesheets||o.inlinedStylesheets,inline:n.inline,inlineRequest:o.options.inlineRequest,inlineTimeout:o.options.inlineTimeout,isRemote:n.isRemote||!1,localOnly:o.localOnly,outputTokens:[],rebaseTo:o.options.rebaseTo,sourceTokens:e,warnings:o.warnings};return doInlineImports(t)}function doInlineImports(e){var o,n,r;for(n=0,r=e.sourceTokens.length;n<r;n++){if(o=e.sourceTokens[n],o[0]==Token.AT_RULE&&isImport(o[1]))return e.sourceTokens.splice(0,n),inlineStylesheet(o,e);o[0]==Token.AT_RULE||o[0]==Token.COMMENT?e.outputTokens.push(o):(e.outputTokens.push(o),e.afterContent=!0)}return e.sourceTokens=[],e.callback(e.outputTokens)}function inlineStylesheet(e,o){var n=extractImportUrlAndMedia(e[1]),r=n[0],t=n[1],s=e[2];return isRemoteResource(r)?inlineRemoteStylesheet(r,t,s,o):inlineLocalStylesheet(r,t,s,o)}function inlineRemoteStylesheet(e,o,n,r){function t(t,s){return t?(r.errors.push('Broken @import declaration of "'+e+'" - '+t),process.nextTick(function(){r.outputTokens=r.outputTokens.concat(r.sourceTokens.slice(0,1)),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)})):(r.inline=r.externalContext.options.inline,r.isRemote=!0,r.externalContext.source=i,r.externalContext.sourcesContent[e]=s,r.externalContext.stats.originalSize+=s.length,fromStyles(s,r.externalContext,r,function(e){return e=wrapInMedia(e,o,n),r.outputTokens=r.outputTokens.concat(e),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)}))}var s=isAllowedResource(e,!0,r.inline),i=e,a=e in r.externalContext.sourcesContent,u=!hasProtocol(e);return r.inlinedStylesheets.indexOf(e)>-1?(r.warnings.push('Ignoring remote @import of "'+e+'" as it has already been imported.'),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)):r.localOnly&&r.afterContent?(r.warnings.push('Ignoring remote @import of "'+e+'" as no callback given and after other content.'),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)):u?(r.warnings.push('Skipping remote @import of "'+e+'" as no protocol given.'),r.outputTokens=r.outputTokens.concat(r.sourceTokens.slice(0,1)),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)):r.localOnly&&!a?(r.warnings.push('Skipping remote @import of "'+e+'" as no callback given.'),r.outputTokens=r.outputTokens.concat(r.sourceTokens.slice(0,1)),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)):!s&&r.afterContent?(r.warnings.push('Ignoring remote @import of "'+e+'" as resource is not allowed and after other content.'),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)):s?(r.inlinedStylesheets.push(e),a?t(null,r.externalContext.sourcesContent[e]):r.fetch(e,r.inlineRequest,r.inlineTimeout,t)):(r.warnings.push('Skipping remote @import of "'+e+'" as resource is not allowed.'),r.outputTokens=r.outputTokens.concat(r.sourceTokens.slice(0,1)),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r))}function inlineLocalStylesheet(e,o,n,r){var t,s=path.resolve(""),i=path.isAbsolute(e)?path.resolve(s,"/"==e[0]?e.substring(1):e):path.resolve(r.rebaseTo,e),a=path.relative(s,i),u=isAllowedResource(e,!1,r.inline),l=normalizePath(a),c=l in r.externalContext.sourcesContent;if(r.inlinedStylesheets.indexOf(i)>-1)r.warnings.push('Ignoring local @import of "'+e+'" as it has already been imported.');else if(c||fs.existsSync(i)&&fs.statSync(i).isFile())if(!u&&r.afterContent)r.warnings.push('Ignoring local @import of "'+e+'" as resource is not allowed and after other content.');else if(r.afterContent)r.warnings.push('Ignoring local @import of "'+e+'" as after other content.');else{if(u)return t=c?r.externalContext.sourcesContent[l]:fs.readFileSync(i,"utf-8"),r.inlinedStylesheets.push(i),r.inline=r.externalContext.options.inline,r.externalContext.source=l,r.externalContext.sourcesContent[l]=t,r.externalContext.stats.originalSize+=t.length,fromStyles(t,r.externalContext,r,function(e){return e=wrapInMedia(e,o,n),r.outputTokens=r.outputTokens.concat(e),r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)});r.warnings.push('Skipping local @import of "'+e+'" as resource is not allowed.'),r.outputTokens=r.outputTokens.concat(r.sourceTokens.slice(0,1))}else r.errors.push('Ignoring local @import of "'+e+'" as resource is missing.');return r.sourceTokens=r.sourceTokens.slice(1),doInlineImports(r)}function wrapInMedia(e,o,n){return o?[[Token.NESTED_BLOCK,[[Token.NESTED_BLOCK_SCOPE,"@media "+o,n]],e]]:e}var fs=require("fs"),path=require("path"),applySourceMaps=require("./apply-source-maps"),extractImportUrlAndMedia=require("./extract-import-url-and-media"),isAllowedResource=require("./is-allowed-resource"),loadOriginalSources=require("./load-original-sources"),normalizePath=require("./normalize-path"),rebase=require("./rebase"),rebaseLocalMap=require("./rebase-local-map"),rebaseRemoteMap=require("./rebase-remote-map"),restoreImport=require("./restore-import"),tokenize=require("../tokenizer/tokenize"),Token=require("../tokenizer/token"),Marker=require("../tokenizer/marker"),hasProtocol=require("../utils/has-protocol"),isImport=require("../utils/is-import"),isRemoteResource=require("../utils/is-remote-resource"),UNKNOWN_URI="uri:unknown";module.exports=readSources;