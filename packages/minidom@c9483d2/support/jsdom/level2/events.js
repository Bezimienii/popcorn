function getDocument(t){return t.nodeType==core.Node.DOCUMENT_NODE?t:t._ownerDocument}function mutationEventsEnabled(t){return t.nodeType!=core.Node.ATTRIBUTE_NODE&&getDocument(t).implementation.hasFeature("MutationEvents")}function dispatchAttrEvent(t){return function(e,n,r){var i=this._parentNode,o=e.apply(this,n);if(mutationEventsEnabled(i)){var s,a=i._ownerDocument,u=events.MutationEvent.prototype[t],l=o&&o.name||r.name,v=o&&o.value||null,c="ADDITION"==t?r.value:null;c&&c==v||(s=a.createEvent("MutationEvents"),s.initMutationEvent("DOMAttrModified",!0,!1,i,v,c,l,u),i.dispatchEvent(s))}return o}}var core=require("./core").dom.level2.core,utils=require("../utils");core=Object.create(core);var events={};events.EventException=function(){arguments.length>0?this._code=arguments[0]:this._code=0,arguments.length>1?this._message=arguments[1]:this._message="Unspecified event type",Error.call(this,this._message),Error.captureStackTrace&&Error.captureStackTrace(this,events.EventException)},events.EventException.prototype={UNSPECIFIED_EVENT_TYPE_ERR:0,get code(){return this._code}},events.EventException.prototype.__proto__=Error.prototype,events.Event=function(t){this._eventType=t,this._type=null,this._bubbles=null,this._cancelable=null,this._target=null,this._currentTarget=null,this._eventPhase=null,this._timeStamp=null,this._preventDefault=!1,this._stopPropagation=!1},events.Event.prototype={initEvent:function(t,e,n){this._type=t,this._bubbles=e,this._cancelable=n},preventDefault:function(){this._cancelable&&(this._preventDefault=!0)},stopPropagation:function(){this._stopPropagation=!0},CAPTURING_PHASE:1,AT_TARGET:2,BUBBLING_PHASE:3,get eventType(){return this._eventType},get type(){return this._type},get bubbles(){return this._bubbles},get cancelable(){return this._cancelable},get target(){return this._target},get currentTarget(){return this._currentTarget},get eventPhase(){return this._eventPhase},get timeStamp(){return this._timeStamp}},events.UIEvent=function(t){events.Event.call(this,t),this.view=null,this.detail=null},events.UIEvent.prototype={initUIEvent:function(t,e,n,r,i){this.initEvent(t,e,n),this.view=r,this.detail=i}},events.UIEvent.prototype.__proto__=events.Event.prototype,events.MouseEvent=function(t){events.UIEvent.call(this,t),this.screenX=null,this.screenY=null,this.clientX=null,this.clientY=null,this.ctrlKey=null,this.shiftKey=null,this.altKey=null,this.metaKey=null,this.button=null,this.relatedTarget=null},events.MouseEvent.prototype={initMouseEvent:function(t,e,n,r,i,o,s,a,u,l,v,c,h,E,p){this.initUIEvent(t,e,n,r,i),this.screenX=o,this.screenY=s,this.clientX=a,this.clientY=u,this.ctrlKey=l,this.shiftKey=c,this.altKey=v,this.metaKey=h,this.button=E,this.relatedTarget=p}},events.MouseEvent.prototype.__proto__=events.UIEvent.prototype,events.MutationEvent=function(t){events.Event.call(this,t),this.relatedNode=null,this.prevValue=null,this.newValue=null,this.attrName=null,this.attrChange=null},events.MutationEvent.prototype={initMutationEvent:function(t,e,n,r,i,o,s,a){this.initEvent(t,e,n),this.relatedNode=r,this.prevValue=i,this.newValue=o,this.attrName=s,this.attrChange=a},MODIFICATION:1,ADDITION:2,REMOVAL:3},events.MutationEvent.prototype.__proto__=events.Event.prototype,events.EventTarget=function(){},events.EventTarget.getListeners=function(t,e,n){var r=t._listeners&&t._listeners[e]&&t._listeners[e][n]||[];if(!n){var i=t["on"+e];if(i){var o=t._ownerDocument?t._ownerDocument.implementation:t.document.implementation;o.hasFeature("ProcessExternalResources","script")&&r.push(i)}}return r},events.EventTarget.dispatch=function(t,e,n){for(var r,i,o=e();o&&!t._stopPropagation;){for(r=events.EventTarget.getListeners(o,t._type,n),i=r.length;i--;){t._currentTarget=o;try{r[i].call(o,t)}catch(s){o.raise("error","Dispatching event '"+t._type+"' failed",{error:s,event:t})}}o=e()}return!t._stopPropagation},events.EventTarget.forwardIterator=function(t){var e=0,n=t.length;return function(){return e<n?t[e++]:null}},events.EventTarget.backwardIterator=function(t){var e=t.length;return function(){return e>=0?t[--e]:null}},events.EventTarget.singleIterator=function(t){var e=1;return function(){return e--?t:null}},events.EventTarget.prototype={addEventListener:function(t,e,n){this._listeners=this._listeners||{};var r=this._listeners[t]||{};n=n===!0;for(var i=r[n]||[],o=0;o<i.length;o++)if(i[o]===e)return;i.push(e),r[n]=i,this._listeners[t]=r},removeEventListener:function(t,e,n){var r=this._listeners&&this._listeners[t];if(r){var i=r[n===!0];if(i)for(var o=0;o<i.length;o++)if(i[o]===e)return void i.splice(o,1)}},dispatchEvent:function(t){if(null==t)throw new events.EventException(0,"Null event");if(null==t._type||""==t._type)throw new events.EventException(0,"Uninitialized event");var e=[];t._target=this;for(var n=this,r=n._parentNode;r;)e.push(r),n=r,r=n._parentNode;r=n._parentWindow,r&&e.push(r);var i=events.EventTarget.backwardIterator(e);if(t._eventPhase=t.CAPTURING_PHASE,!events.EventTarget.dispatch(t,i,!0))return t._preventDefault;if(i=events.EventTarget.singleIterator(t._target),t._eventPhase=t.AT_TARGET,!events.EventTarget.dispatch(t,i,!1))return t._preventDefault;if(t._bubbles&&!t._stopPropagation){i=events.EventTarget.forwardIterator(e),t._eventPhase=t.BUBBLING_PHASE,events.EventTarget.dispatch(t,i,!1)}return t._preventDefault}},core.Node.prototype.__proto__=events.EventTarget.prototype,utils.intercept(core.Node,"insertBefore",function(t,e,n,r){var i=t.apply(this,e);if(mutationEventsEnabled(this)){var o=getDocument(this),s=o.createEvent("MutationEvents");s.initMutationEvent("DOMNodeInserted",!0,!1,this,null,null,null,null),n.dispatchEvent(s),(this.nodeType==core.Node.DOCUMENT_NODE||this._attachedToDocument)&&(s=o.createEvent("MutationEvents"),s.initMutationEvent("DOMNodeInsertedIntoDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(t){t.nodeType==core.Node.ELEMENT_NODE&&(t.dispatchEvent(s),t._attachedToDocument=!0)}))}return i}),utils.intercept(core.Node,"removeChild",function(t,e,n){if(mutationEventsEnabled(this)){var r=getDocument(this),i=r.createEvent("MutationEvents");i.initMutationEvent("DOMNodeRemoved",!0,!1,this,null,null,null,null),n.dispatchEvent(i),i=r.createEvent("MutationEvents"),i.initMutationEvent("DOMNodeRemovedFromDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(t){t.nodeType==core.Node.ELEMENT_NODE&&(t.dispatchEvent(i),t._attachedToDocument=!1)})}return t.apply(this,e)}),utils.intercept(core.AttrNodeMap,"removeNamedItem",dispatchAttrEvent("REMOVAL")),utils.intercept(core.AttrNodeMap,"setNamedItem",dispatchAttrEvent("ADDITION")),core.CharacterData.prototype.__defineGetter__("_nodeValue",function(){return this.__nodeValue}),core.CharacterData.prototype.__defineSetter__("_nodeValue",function(t){var e=this.__nodeValue;if(this.__nodeValue=t,this._ownerDocument&&this._parentNode&&mutationEventsEnabled(this)){var n=this._ownerDocument.createEvent("MutationEvents");n.initMutationEvent("DOMCharacterDataModified",!0,!1,this,e,t,null,null),this.dispatchEvent(n)}}),core.Document.prototype.createEvent=function(t){switch(t){case"MutationEvents":return new events.MutationEvent(t);case"UIEvents":return new events.UIEvent(t);case"MouseEvents":return new events.MouseEvent(t);case"HTMLEvents":return new events.Event(t)}return new events.Event(t)},exports.dom={level2:{core:core,events:events}};