function bundleMontageHtml(e,t,a){return Bundle.verifyPackageLocation(e,t,a),loadMontageScript(e,t,a).then(function(n){var o=collectMontageBootstrapBundle(n,t["package"],a);return Bundle.collectPreloadBundles(n,t["package"],a).then(function(n){var r=Bundle.createPreloadBundles(n,t,a);bundleMontageScript(o,r,e,t,a)})})}function bundleMontageScript(e,t,a,n,o){var r=t.map(function(e){return e.map(function(e){return o.out.log("Bundle:",e.buildLocation,e.utf8.length,"bytes"),URL.relative(n.buildLocation,e.buildLocation)})});e.unshift("BUNDLE="+JSON.stringify(r)+";");var i=Bundle.createBundle(e,n,o,"bundle-0");o.out.log("Bundle:",i.buildLocation,i.utf8.length,"bytes (montage bootstrap)");var u=n["package"],l=n["package"].getPackage({name:"montage"}),c=n["package"].getPackage({name:"bluebird"}),d=URL.relative(n.buildLocation,i.buildLocation),g=URL.relative(n.buildLocation,l.buildLocation),s=URL.relative(n.buildLocation,c.buildLocation);a.setAttribute("src",d),a.setAttribute("data-montage-location",g),a.setAttribute("data-promise-location",s),a.setAttribute("data-montage-hash",l.hash),a.setAttribute("data-promise-hash",c.hash),a.setAttribute("data-application-hash",u.hash)}function loadMontageScript(e,t,a){var n=t["package"].location,o=t["package"].getPackage({name:"montage"}).location;return MontageBootstrap.loadPackage(n,a).then(function(a){return a.loadPackage(o).then(function(e){var t=URL.resolve(e.location,"node_modules/bluebird");return[e,e.loadPackage({location:t})]}).spread(function(e){return Promise.all(["core/core","core/event/event-manager","core/serialization/deserializer/montage-reviver","core/logger"].map(e.deepLoad))}).then(function(){return a.deepLoad(t.relativeLocation)["catch"](function(e){throw e.message="Can't find dependencies of HTML application "+JSON.stringify(t.location)+" because "+e.message,e}).then(function(){if(e.hasAttribute("data-module"))return a.deepLoad(e.getAttribute("data-module"))["catch"](function(t){throw t.message="Can't find dependencies of HTML application data-module "+JSON.stringify(e.getAttribute("data-module"))+" because "+t.message,t})})["return"](a)})})}function collectMontageBootstrapBundle(e,t,a){var n=t.getPackage({name:"montage"}),o=t.getPackage({name:"mr"}),r=t.getPackage({name:"bluebird"}),i=[n.files["montage.js"].utf8,o.files["require.js"].utf8,o.files["browser.js"].utf8,r.files["js/browser/bluebird.min.js"].utf8];return e.getPackage({name:"montage"}).getModuleDescriptor("core/promise").bundled=!0,e.getPackage({name:"bluebird"}).getModuleDescriptor("bluebird").bundled=!0,Bundle.collectBundle(e,t,a,i)}var Bundle=require("../bundle"),MontageBootstrap=require("montage"),URL=require("url2"),Promise=require("bluebird");module.exports=bundleMontageHtml;