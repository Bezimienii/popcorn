function transformHtml(t,e,i){transformDocument(t,e);try{t.utf8=minifyHtml(t.utf8,{removeComments:!0,collapseBooleanLiterals:!0,collapseWhitespace:!0,removeAttributeQuotes:!0,removeRedundantAttributes:!0,removeEmptyAttributes:!0})}catch(a){e.out.warn("Could not minify "+t.path),e.out.warn(a.message)}var r="montageDefine("+JSON.stringify(t["package"].hash)+","+JSON.stringify(t.relativeLocation)+","+JSON.stringify({text:t.utf8})+")",n=new File({fs:e.fs,utf8:r,location:t.location+".load.js",buildLocation:t.buildLocation+".load.js",relativeLocation:t.relativeLocation+".load.js","package":t["package"]});e.files[n.location]=n,t["package"].files[n.relativeLocation]=n,i&&i()}function transformDocument(t,e){var i,a,r,n=t["package"].getPackage({main:!0}),o=URL.resolve(n.buildLocation,"manifest.appcache");visit(t.document,function(s){if(s.nodeType===Node.ELEMENT_NODE)switch(s.tagName){case"HTML":if(n.packageDescription.appcache){var c=URL.relative(t.buildLocation,o);s.setAttribute("manifest",c)}break;case"STYLE":rebaseStyleTag(s,t,e);break;case"SCRIPT":rebaseAttribute(s,"src",t,e),rebaseScriptTag(s,t,e);break;case"LINK":if(e.cssEmbedding&&"stylesheet"===s.getAttribute("rel")&&(r=s.getAttribute("href"),r.indexOf(":")===-1)){i=e.files[URL.resolve(t.location,r)],void 0===i&&e.out.warn("Stylesheet file not found: "+URL.resolve(t.location,r)),i=i?i.utf8:"",a=t.document.createElement("style"),rebaseAttribute(s,"href",t,e);var l,u=URL.resolve(s.getAttribute("href"),URL.relative(n.buildLocation,t.buildLocation));l=transformCss.resolve(u,i,e).trim(),l.length?(a.appendChild(t.document.createTextNode(l)),s.parentNode.replaceChild(a,s)):s.parentNode.removeChild(s)}break;default:rebaseAttribute(s,"href",t,e),rebaseAttribute(s,"src",t,e)}})}function rebaseStyleTag(t,e,i){var a=getText(t),r=transformCss.rebase(a,e,i);setText(t,r,e.document)}function rebaseScriptTag(t,e,i){var a;if(a=t.hasAttribute("type")?t.getAttribute("type"):"application/javascript","application/javascript"===a||"text/javascript"===a){if(i.lint&&e["package"].isMainPackage()&&(t.hasAttribute("src")&&""!==getText(t).trim()&&i.out.warn("A script tag must only have either a src or content in "+e.path),"text/javascript"===a?i.out.warn("Proper MIME type for JavaScript is application/javascript and should be omitted in "+e.path):t.hasAttribute("type")&&i.out.warn("Script MIME type should be omitted if application/javascript in "+e.path),jshint(getText(t))||i.out.warn("JSHints for <script>: "+e.path)),t.hasAttribute("type")&&t.removeAttribute("type"),i.minify)try{setText(t,minifyJavaScript(getText(t),e.path),e.document)}catch(r){i.out.warn("JavaScript parse error in "+e.path+": "+r.message)}}else if("text/m-objects"===a)i.out.warn("Deprecated text/m-objects block in "+e.path+". Use text/montage-serialization.");else if("text/montage-serialization"===a)try{i.minify&&setText(t,JSON.stringify(JSON.parse(getText(t))),e.document)}catch(n){if(!(n instanceof SyntaxError))throw n;i.out.warn("Syntax Error in Montage Serialization in "+e.path)}else"x-shader/x-fragment"===a||"x-shader/x-vertex"===a||i.out.warn("Unrecognized script type "+JSON.stringify(a)+" in "+e.path)}function visit(t,e){var i;for(e(t),t=t.firstChild;t;)i=t.nextSibling,visit(t,e),t=i}function rebaseAttribute(t,e,i,a){if(t.hasAttribute(e)){var r=t.getAttribute(e),n=rebase(r,i,a);t.setAttribute(e,n)}}function getText(t){return t.textContent}function setText(t,e,i){for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(i.createTextNode(e))}var rebase=require("../rebase"),minifyJavaScript=require("../minify-javascript"),jshint=require("jshint"),File=require("../file"),transformCss=require("./css");require("../shim-minidom");var Node=require("minidom/dom").Node,URL=require("url2"),minifyHtml=require("html-minifier").minify;module.exports=transformHtml;