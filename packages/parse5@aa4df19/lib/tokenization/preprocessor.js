"use strict";function isReservedCodePoint(t){return t>=55296&&t<=57343||t>1114111}function isSurrogatePair(t,s){return t>=55296&&t<=56319&&s>=56320&&s<=57343}function getSurrogatePairCodePoint(t,s){return 1024*(t-55296)+9216+s}var UNICODE=require("../common/unicode"),$=UNICODE.CODE_POINTS,CARRIAGE_RETURN_NEW_LINE_REGEX=/\r\n?/g,Preprocessor=module.exports=function(t){this.write(t),this.pos=this.html.charCodeAt(0)===$.BOM?0:-1,this.gapStack=[],this.lastGapPos=-1};Preprocessor.prototype.write=function(t){t=t.replace(CARRIAGE_RETURN_NEW_LINE_REGEX,"\n"),this.html?this.html=this.html.substring(0,this.pos+1)+t+this.html.substring(this.pos+1,this.html.length):this.html=t,this.lastCharPos=this.html.length-1},Preprocessor.prototype.advanceAndPeekCodePoint=function(){if(this.pos++,this.pos>this.lastCharPos)return $.EOF;var t=this.html.charCodeAt(this.pos);if(t>=55296){if(this.pos!==this.lastCharPos){var s=this.html.charCodeAt(this.pos+1);isSurrogatePair(t,s)&&(this.pos++,t=getSurrogatePairCodePoint(t,s),this.gapStack.push(this.lastGapPos),this.lastGapPos=this.pos)}isReservedCodePoint(t)&&(t=$.REPLACEMENT_CHARACTER)}return t},Preprocessor.prototype.retreat=function(){this.pos===this.lastGapPos&&(this.lastGapPos=this.gapStack.pop(),this.pos--),this.pos--};