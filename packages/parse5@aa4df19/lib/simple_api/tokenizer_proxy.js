"use strict";var Tokenizer=require("../tokenization/tokenizer"),ForeignContent=require("../common/foreign_content"),UNICODE=require("../common/unicode"),HTML=require("../common/html"),$=HTML.TAG_NAMES,NS=HTML.NAMESPACES,TokenizerProxy=module.exports=function(e){this.tokenizer=new Tokenizer(e),this.namespaceStack=[],this.namespaceStackTop=-1,this.currentNamespace=null,this.inForeignContent=!1};TokenizerProxy.prototype.getNextToken=function(){var e=this.tokenizer.getNextToken();return e.type===Tokenizer.START_TAG_TOKEN?this._handleStartTagToken(e):e.type===Tokenizer.END_TAG_TOKEN?this._handleEndTagToken(e):e.type===Tokenizer.NULL_CHARACTER_TOKEN&&this.inForeignContent&&(e.type=Tokenizer.CHARACTER_TOKEN,e.chars=UNICODE.REPLACEMENT_CHARACTER),e},TokenizerProxy.prototype._enterNamespace=function(e){this.namespaceStackTop++,this.namespaceStack.push(e),this.inForeignContent=e!==NS.HTML,this.currentNamespace=e,this.tokenizer.allowCDATA=this.inForeignContent},TokenizerProxy.prototype._leaveCurrentNamespace=function(){this.namespaceStackTop--,this.namespaceStack.pop(),this.currentNamespace=this.namespaceStack[this.namespaceStackTop],this.inForeignContent=this.currentNamespace!==NS.HTML,this.tokenizer.allowCDATA=this.inForeignContent},TokenizerProxy.prototype._ensureTokenizerState=function(e){e===$.TEXTAREA||e===$.TITLE?this.tokenizer.state=Tokenizer.RCDATA_STATE:e===$.PLAINTEXT?this.tokenizer.state=Tokenizer.PLAINTEXT_STATE:e===$.SCRIPT?this.tokenizer.state=Tokenizer.SCRIPT_DATA_STATE:e!==$.STYLE&&e!==$.IFRAME&&e!==$.XMP&&e!==$.NOEMBED&&e!==$.NOFRAMES&&e!==$.NOSCRIPT||(this.tokenizer.state=Tokenizer.RAWTEXT_STATE)},TokenizerProxy.prototype._handleStartTagToken=function(e){var t=e.tagName;t===$.SVG?this._enterNamespace(NS.SVG):t===$.MATH?this._enterNamespace(NS.MATHML):this.inForeignContent?ForeignContent.causesExit(e)?this._leaveCurrentNamespace():(ForeignContent.isMathMLTextIntegrationPoint(t,this.currentNamespace)||ForeignContent.isHtmlIntegrationPoint(t,this.currentNamespace,e.attrs))&&this._enterNamespace(NS.HTML):this._ensureTokenizerState(t)},TokenizerProxy.prototype._handleEndTagToken=function(e){var t=e.tagName;if(this.inForeignContent)(t===$.SVG&&this.currentNamespace===NS.SVG||t===$.MATH&&this.currentNamespace===NS.MATHML)&&this._leaveCurrentNamespace();else{var n=this.namespaceStack[this.namespaceStackTop-1];ForeignContent.isMathMLTextIntegrationPoint(t,n)||ForeignContent.isHtmlIntegrationPoint(t,n,e.attrs)?this._leaveCurrentNamespace():t===$.SCRIPT&&(this.tokenizer.state=Tokenizer.DATA_STATE)}};