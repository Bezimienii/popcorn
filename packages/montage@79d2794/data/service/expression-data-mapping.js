var DataMapping=require("./data-mapping").DataMapping,assign=require("frb/assign"),compile=require("frb/compile-evaluator"),ObjectDescriptorReference=require("core/meta/object-descriptor-reference").ObjectDescriptorReference,parse=require("frb/parse"),MappingRule=require("data/service/mapping-rule").MappingRule,Promise=require("core/promise").Promise,Scope=require("frb/scope"),Set=require("collections/set"),ONE_WAY_BINDING="<-",TWO_WAY_BINDING="<->";exports.ExpressionDataMapping=DataMapping.specialize({serializeSelf:{value:function(e){}},deserializeSelf:{value:function(e){var r=e.getProperty("objectDescriptor");r instanceof ObjectDescriptorReference?this.objectDescriptorReference=r:this.objectDescriptor=r,this.schemaReference=e.getProperty("schema"),r=e.getProperty("objectMapping"),r&&(this._objectMappingRules=r.rules),r=e.getProperty("rawDataMapping"),r&&(this._rawDataMappingRules=r.rules),r=e.getProperty("requisitePropertyNames"),r&&this.addRequisitePropertyName.apply(this,r),r=e.getProperty("rawDataPrimaryKeys"),r&&(this.rawDataPrimaryKeys=r)}},initWithServiceObjectDescriptorAndSchema:{value:function(e,r,t){return this.service=e,this.objectDescriptor=r,this.schemaDescriptor=t,this}},resolveReferences:{value:function(){var e=this;return this._resolveObjectDescriptorReferenceIfNecessary().then(function(){return e._resolveSchemaReferenceIfNecessary()})}},_resolveObjectDescriptorReferenceIfNecessary:{value:function(){var e=this,r=!this.objectDescriptor&&this.objectDescriptorReference,t=r?this.objectDescriptorReference.promise(require):Promise.resolve(null);return t.then(function(r){return r&&(e.objectDescriptor=r),null})}},_resolveSchemaReferenceIfNecessary:{value:function(){var e=this,r=!this.schemaDescriptor&&this.schemaDescriptorReference,t=r?this.schemaReference.promise(require):Promise.resolve(null);return t.then(function(r){return r&&(e.schemaDescriptor=r),null})}},objectDescriptor:{get:function(){return this._objectDescriptor},set:function(e){this._objectDescriptor=e,this._objectDescriptorReference=(new ObjectDescriptorReference).initWithValue(e)}},schemaDescriptor:{get:function(){return this._schemaDescriptor},set:function(e){this._schemaDescriptor=e,this._schemaDescriptorReference=(new ObjectDescriptorReference).initWithValue(e)}},objectDescriptorReference:{get:function(){return this._objectDescriptorReference?this._objectDescriptorReference.promise(require):Promise.resolve(null)},set:function(e){this._objectDescriptorReference=e}},schemaDescriptorReference:{get:function(){return this._schemaDescriptorReference?this._schemaDescriptorReference.promise(require):Promise.resolve(null)},set:function(e){this._schemaDescriptorReference=e}},service:{value:void 0},addRequisitePropertyName:{value:function(){var e,r,t;for(e=0,r=arguments.length;e<r;e+=1)t=arguments[e],this._requisitePropertyNames.has(t)||this._requisitePropertyNames.add(t)}},requisitePropertyNames:{get:function(){return this._requisitePropertyNames}},addObjectMappingRule:{value:function(e,r){var t={};t[e]=r,this._mapObjectMappingRules(t,!0),this._mapRawDataMappingRules(t)}},addRawDataMappingRule:{value:function(e,r){var t={};t[e]=r,this._mapRawDataMappingRules(t,!0),this._mapObjectMappingRules(t)}},mapRawDataToObject:{value:function(e,r){var t,i,a,s=this.requisitePropertyNames,n=s.values();if(s.size){for(t=[];i=n.next().value;)t.push(this.mapRawDataToObjectProperty(e,r,i));a=Promise.all(t)}else a=Promise.resolve(null);return a}},mapObjectToRawData:{value:function(e,r){var t,i,a=this._compiledRawDataMappingRules,s=[],n=Object.keys(a);for(i=0;t=n[i];++i)s.push(this.mapObjectToRawDataProperty(e,r,t));return s&&s.length&&Promise.all(s)||Promise.resolve(null)}},mapObjectToCriteriaSourceForProperty:{value:function(e,r,t){var i,a=this._compiledRawDataMappingRules,s=this._compiledObjectMappingRules[t],n=s?s.requirements:[],o=new Set(n),p=[];for(i in a)a.hasOwnProperty(i)&&o.has(i)&&p.push(this._getAndMapObjectProperty(e,r,i,t));return p&&p.length&&Promise.all(p)||Promise.resolve(null)}},_propertiesRequestedForLayer:{get:function(){return this.__propertiesRequestedForLayer||(this.__propertiesRequestedForLayer=new Map),this.__propertiesRequestedForLayer}},_getAndMapObjectProperty:{value:function(e,r,t){var i,a=this,s=this._compiledRawDataMappingRules,n=s[t],o=n?n.requirements:[];return i=this.service.rootService.getObjectPropertyExpressions(e,o),i&&"function"==typeof i.then?i.then(function(){return a.mapObjectToRawDataProperty(e,r,t)}):this.mapObjectToRawDataProperty(e,r,t)}},mapObjectToRawDataProperty:{value:function(e,r,t){var i,a=this,s=this._compiledRawDataMappingRules,n=new Scope(e),o=s[t],p=o&&o.propertyDescriptor;return i=p?p.valueDescriptor.then(function(r){return a._prepareObjectToRawDataRule(o),r&&o.converter?a._convertRelationshipToRawData(e,p,o,n):a._parse(o,n)}):Promise.resolve(this._parse(o,n)),i&&i.then(function(e){r[t]=e})||Promise.resolve(null)}},_prepareObjectToRawDataRule:{value:function(e){var r=e.converter,t=e.propertyDescriptor;r&&(r.expression=r.expression||e.expression,r.foreignDescriptor=r.foreignDescriptor||t.valueDescriptor)}},serviceIdentifierForProperty:{value:function(e){var r=this._compiledObjectMappingRules[e];return r&&r.serviceIdentifier}},_compiledObjectMappingRules:{get:function(){return this.__compiledObjectMappingRules||(this.__compiledObjectMappingRules={},this._mapObjectMappingRules(this._rawDataMappingRules),this._mapObjectMappingRules(this._objectMappingRules,!0)),this.__compiledObjectMappingRules}},_compiledRawDataMappingRules:{get:function(){return this.__compiledRawDataMappingRules||(this.__compiledRawDataMappingRules={},this._mapRawDataMappingRules(this._objectMappingRules),this._mapRawDataMappingRules(this._rawDataMappingRules,!0)),this.__compiledRawDataMappingRules}},_rawDataMappingRules:{value:void 0},rawDataPrimaryKeys:{value:void 0},rawDataPrimaryKeyExpressions:{get:function(){return!this._rawDataPrimaryKeyExpressions&&this.rawDataPrimaryKeys&&(this._rawDataPrimaryKeyExpressions=this.rawDataPrimaryKeys.map(function(e){return compile(parse(e))})),this._rawDataPrimaryKeyExpressions}},_requisitePropertyNames:{get:function(){return this.__requisitePropertyNames||(this.__requisitePropertyNames=new Set),this.__requisitePropertyNames}},_mapObjectMappingRules:{value:function(e,r){var t,i,a,s,n=this._compiledObjectMappingRules,o=e?Object.keys(e):[];for(s=0;t=o[s];++s)i=e[t],this._shouldMapRule(i,r)&&(a=r?this._objectMappingRuleWithPropertyNameAndObjectMappingRule(t,i):this._objectMappingRuleWithPropertyNameAndRawDataMappingRule(t,i),n[a.targetPath]=a)}},_mapRawDataMappingRules:{value:function(e,r){var t,i,a,s,n=this._compiledRawDataMappingRules,o=e?Object.keys(e):[];for(s=0;t=o[s];++s)i=e[t],this._shouldMapRule(i,r)&&(a=r?this._rawDataMappingRuleWithPropertyNameAndRawDataMappingRule(t,i):this._rawDataMappingRuleWithPropertyNameAndObjectMappingRule(t,i),n[a.targetPath]=a)}},_objectMappingRuleWithPropertyNameAndObjectMappingRule:{value:function(e,r){var t=this.objectDescriptor.propertyDescriptorForName[e],i=r[ONE_WAY_BINDING]||r[TWO_WAY_BINDING],a=this._makeRule(i,e);return a.converter=r.converter||this._defaultConverter(i,e,!0),a.inversePropertyName=r.inversePropertyName,a.isReverter=!1,a.propertyDescriptor=t,a.serviceIdentifier=r.serviceIdentifier,a}},_rawDataMappingRuleWithPropertyNameAndRawDataMappingRule:{value:function(e,r){var t=this.schemaDescriptor,i=this.schemaDescriptor&&t.propertyDescriptorForName[e],a=r[ONE_WAY_BINDING]||r[TWO_WAY_BINDING],s=this._makeRule(a,e);return s.converter=r.converter||this._defaultConverter(a,e,!1),s.inversePropertyName=r.inversePropertyName,s.isReverter=!1,s.propertyDescriptor=i,s.serviceIdentifier=r.serviceIdentifier,s}},_objectMappingRuleWithPropertyNameAndRawDataMappingRule:{value:function(e,r){var t=r[TWO_WAY_BINDING],i=this.objectDescriptor.propertyDescriptorForName[t],a=this._makeRule(e,t);return a.converter=r.converter||this._defaultConverter(e,t,!0),a.inversePropertyName=r.inversePropertyName,a.isReverter=!0,a.propertyDescriptor=i,a.serviceIdentifier=r.serviceIdentifier,a}},_rawDataMappingRuleWithPropertyNameAndObjectMappingRule:{value:function(e,r){var t=r[TWO_WAY_BINDING],i=this.schemaDescriptor,a=this.schemaDescriptor&&i.propertyDescriptorForName[e],s=this._makeRule(e,t);return s.converter=r.converter||this._defaultConverter(e,t,!1),s.inversePropertyName=r.inversePropertyName,s.isReverter=!0,s.propertyDescriptor=a,s.serviceIdentifier=r.serviceIdentifier,s}},_makeRule:{value:function(e,r){var t=this._compileRuleExpression(e),i=new MappingRule;return i.expression=t.expression,i.requirements=this._parseRequirementsFromParsedExpression(t.parsed),i.targetPath=r,i}},_makeRuleFromRawRule:{value:function(e,r,t){var i=t?e[ONE_WAY_BINDING]||e[TWO_WAY_BINDING]:r,a=this.objectDescriptor.propertyDescriptorForName(i),s=t?e[ONE_WAY_BINDING]||e[TWO_WAY_BINDING]:r,n=t&&r||e[TWO_WAY_BINDING],o=this._compileRuleExpression(s),p=new MappingRule;return p.converter=e.converter||this._defaultConverter(s,n),p.expression=o.expression,p.inversePropertyName=e.inversePropertyName,p.isReverter=e.converter&&!t,p.propertyDescriptor=a,p.requirements=this._parseRequirementsFromParsedExpression(o.parsed),p.serviceIdentifier=e.serviceIdentifier,p.targetPath=n,p}},_convertRelationshipToRawData:{value:function(e,r,t,i){return t.converter.revert||console.log("Converter does not have a revert function for property ("+r.name+")"),t.converter.revert(t.expression(i))}},__scope:{value:null},_scope:{get:function(){return this.__scope||new Scope}},mapRawDataToObjectProperty:{value:function(e,r,t){var i,a=this._compiledObjectMappingRules,s=a.hasOwnProperty(t)&&a[t],n=s&&this.objectDescriptor.propertyDescriptorForName(t),o=this._scope,p=this;return o.value=e,i=!n||n.definition?Promise.resolve(null):n.valueDescriptor.then(function(e){var t=!!e;return p._prepareRawDataToObjectRule(s,n),t?p._resolveRelationship(r,n,s,o):p._resolvePrimitive(r,n,s,o)})}},_prepareRawDataToObjectRule:{value:function(e,r){var t=e.converter;t&&(t.expression=t.expression||e.expression,t.foreignDescriptor=t.foreignDescriptor||r.valueDescriptor,t.objectDescriptor=this.objectDescriptor,t.serviceIdentifier=e.serviceIdentifier)}},resolvePrerequisitesForProperty:{value:function(e,r){var t=this._compiledObjectMappingRules[r],i=t&&t.prerequisitePropertyNames||null;return t||console.log("No Rule For:",r),i?this.service.rootService.getObjectProperties(e,i):Promise.resolve(null)}},_resolvePrimitive:{value:function(e,r,t,i){var a=this._parse(t,i),s=this;return new Promise(function(t,i){s._isThenable(a)?a.then(function(i){s._assignDataToObjectProperty(e,r,i),t(null)}):(e[r.name]=a,t(null))})}},_isThenable:{value:function(e){return e&&e.then&&"function"==typeof e.then}},_assignDataToObjectProperty:{value:function(e,r,t){var i=t&&t.length,a=1!==r.cardinality,s=r.name;if(Array.isArray(t)){if(a&&Array.isArray(e[s]))e[s].splice.apply(e[s],[0,1/0].concat(t));else if(a)e[s]=t;else if(i){if(t.length&&t.length>1)throw new Error('ExpressionDataMapping for property "'+this.objectDescriptor.name+"."+s+"\" expects a cardinality of 1 but data to map doesn't match: "+t);e[s]=t[0]}}else e[s]=t}},_assignObjectToDataInverseProperty:{value:function(e,r,t,i){return r.valueDescriptor.then(function(r){var a=r.propertyDescriptorForName(i);return 1===a.cardinality&&t.forEach(function(r){r[i]=e}),null})}},_resolveRelationship:{value:function(e,r,t,i){var a=this;return t.converter.convert(t.expression(i)).then(function(i){return a._assignDataToObjectProperty(e,r,i),t.inversePropertyName&&i&&i.length?a._assignObjectToDataInverseProperty(e,r,i,t.inversePropertyName):null})}},_compileRuleExpression:{value:function(e){var r=parse(e),t=compile(r);return{parsed:r,expression:t}}},_parseRequirementsFromParsedExpression:{value:function(e,r){var t=e.args,i=e.type;if(r=r||[],"property"===i&&"value"===t[0].type)r.push(t[1].value);else if("property"===i&&"property"===t[0].type){var a=[t[1].value];this._parseRequirementsFromParsedExpression(t[0],a),r.push(a.reverse().join("."))}else"record"===i&&this._parseRequirementsFromParsedRecord(e,r);return r}},_parseRequirementsFromParsedRecord:{value:function(e,r){var t=this,i=e.args,a=Object.keys(i);a.forEach(function(e){t._parseRequirementsFromParsedExpression(i[e],r)})}},_parse:{value:function(e,r){var t=e.expression(r);return e.converter?e.isReverter?e.converter.revert(t):e.converter.convert(t):t}},_parseObject:{value:function(e,r){var t=e.expression(r);return e.converter&&e.converter.revert(t)||t}},_shouldMapRule:{value:function(e,r){var t=e.hasOwnProperty(ONE_WAY_BINDING),i=!t&&e.hasOwnProperty(TWO_WAY_BINDING);return t&&r||i}},_defaultConverter:{value:function(e,r,t){var i=t?this.schemaDescriptor:this.objectDescriptor,a=t?this.objectDescriptor:this.schemaDescriptor,s=i&&i.propertyDescriptorForName(e),n=a&&a.propertyDescriptorForName(r),o=s&&s.valueType,p=n&&n.valueType,c=s&&n&&o!==p;return c?this._converterForValueTypes(p,o):null}},_converterForValueTypes:{value:function(e,r){var t=exports.ExpressionDataMapping.defaultConverters;return t[e]&&t[e][r]||null}},mapFromRawData:{value:function(e,r,t){return this.mapRawDataToObject(r,e,t)}},mapToRawData:{value:function(e,r){this.mapObjectToRawData(e,r)}}},{defaultConverters:{get:function(){if(!exports.ExpressionDataMapping._defaultConverters){var e={};exports.ExpressionDataMapping._addDefaultConvertersToMap(e),exports.ExpressionDataMapping._defaultConverters=e}return exports.ExpressionDataMapping._defaultConverters}},_addDefaultConvertersToMap:{value:function(e){exports.ExpressionDataMapping._addDefaultBooleanConvertersToConverters(e),exports.ExpressionDataMapping._addDefaultNumberConvertersToConverters(e),exports.ExpressionDataMapping._addDefaultStringConvertersToConverters(e)}},_addDefaultBooleanConvertersToConverters:{value:function(e){var r={};r.string=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return String(e)}}}),r.number=Object.create({},{convert:{value:function(e){return Boolean(e)}},revert:{value:function(e){return Number(e)}}}),e["boolean"]=r}},_addDefaultNumberConvertersToConverters:{value:function(e){var r={};r.string=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return String(e)}}}),r["boolean"]=Object.create({},{convert:{value:function(e){return Number(e)}},revert:{value:function(e){return Boolean(e)}}}),e.number=r}},_addDefaultStringConvertersToConverters:{value:function(e){var r={};r.number=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Number(e)}}}),r["boolean"]=Object.create({},{convert:{value:function(e){return String(e)}},revert:{value:function(e){return Boolean(e)}}}),e.string=r}}});